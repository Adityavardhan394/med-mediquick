<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediQuick - Browse Medicines</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’Š</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00b386;
      --primary-dark: #009973;
      --primary-light: rgba(0, 179, 134, 0.1);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e6fff9, #ffffff);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Enhanced Background Pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" opacity="0.05"><path d="M20 5L25 15H15L20 5Z" fill="%2300b386"/></svg>');
      background-repeat: repeat;
      z-index: -1;
      animation: patternFloat 60s linear infinite;
    }

    @keyframes patternFloat {
      0% { background-position: 0 0; }
      100% { background-position: 100px 100px; }
    }

    /* Modern Card Styling - Tata 1mg/Apollo inspired */
    .category-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .category-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .category-item:hover::before {
      left: 100%;
    }

    .category-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Enhanced Medicine Cards */
    .medicine-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border: 1px solid rgba(229, 231, 235, 0.5);
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .medicine-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 25px 50px rgba(0, 179, 134, 0.15);
      border-color: rgba(0, 179, 134, 0.3);
    }

    .medicine-card .price-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      z-index: 10;
    }

    .medicine-card .discount-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, #00b386, #00a085);
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 10;
    }

    /* Prescription Required Badge */
    .prescription-required {
      background: linear-gradient(135deg, #ffa726, #ff9800);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* Rating Stars */
    .rating-stars {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .rating-stars .star {
      color: #ffd700;
      font-size: 0.875rem;
    }

    .rating-stars .star.empty {
      color: #e5e7eb;
    }

    /* Trending Badge */
    .trending-badge {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Quick View Button */
    .quick-view-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(0, 179, 134, 0.9);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }

    .medicine-card:hover .quick-view-btn {
      opacity: 1;
      transform: scale(1);
    }

    /* Enhanced Filter Sidebar */
    .filter-sidebar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229, 231, 235, 0.5);
    }

    /* Price Range Styling */
    .price-range-container {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }

    /* Modern Toggle Switches */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background-color: #cbd5e0;
      border-radius: 12px;
      transition: background-color 0.3s;
      cursor: pointer;
    }

    .toggle-switch.active {
      background-color: #00b386;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    /* Floating Action Buttons */
    .floating-actions {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 40;
    }

    .floating-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
    }

    .floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
    }

    /* Search Enhancement */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 12px 12px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 20;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .search-suggestion {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .search-suggestion:hover {
      background-color: #f8fafc;
    }

    .search-suggestion:last-child {
      border-bottom: none;
    }

    /* Notification Badges */
    .notification-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
      60% { transform: translateY(-2px); }
    }

    /* Medicine Availability Indicator */
    .availability-indicator {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse-dot 2s infinite;
    }

    .availability-indicator.low-stock {
      background: #f59e0b;
    }

    .availability-indicator.out-of-stock {
      background: #ef4444;
    }

    @keyframes pulse-dot {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Mobile Responsive Enhancements */
    @media (max-width: 768px) {
      .category-item {
        padding: 12px;
      }
      
      .medicine-card {
        margin-bottom: 16px;
      }
      
      .floating-actions {
        bottom: 80px;
        right: 16px;
      }
      
      .floating-btn {
        width: 48px;
        height: 48px;
      }
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
      .medicine-card {
        background: rgba(31, 41, 55, 0.95);
        border-color: rgba(75, 85, 99, 0.5);
        color: #f9fafb;
      }
      
      .filter-sidebar {
        background: rgba(31, 41, 55, 0.95);
        color: #f9fafb;
      }
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Enhanced Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #00b386, #00a085);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 179, 134, 0.3);
    }

    .medicine-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      animation: cardAppear 0.6s backwards;
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
    }

    .medicine-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 179, 134, 0.15);
    }

    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Card Staggered Animation */
    .medicine-card:nth-child(1) { animation-delay: 0.1s; }
    .medicine-card:nth-child(2) { animation-delay: 0.2s; }
    .medicine-card:nth-child(3) { animation-delay: 0.3s; }
    .medicine-card:nth-child(4) { animation-delay: 0.4s; }
    .medicine-card:nth-child(5) { animation-delay: 0.5s; }
    .medicine-card:nth-child(6) { animation-delay: 0.6s; }

    .medicine-icon {
      transition: all 0.3s ease;
    }

    .medicine-card:hover .medicine-icon {
      transform: scale(1.1) rotate(5deg);
      color: var(--primary);
    }

    .search-container {
      position: relative;
      animation: slideDown 0.5s ease backwards;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .category-pill {
      transition: all 0.3s ease;
    }

    .category-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 179, 134, 0.2);
    }

    /* Enhanced Card Hover Effect */
    .medicine-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,179,134,0.1) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .medicine-card:hover::before {
      opacity: 1;
    }

    /* Additional Typography and Layout Improvements */
    .medicine-card h3 {
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: -0.025em;
    }

    .medicine-card .text-xl {
      font-size: 1.125rem;
    }

    .medicine-card .medicine-info-grid {
      display: grid;
      gap: 0.75rem;
    }

    .medicine-card .price-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .medicine-card .controls-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .medicine-card .pharmacy-info {
      background-color: rgba(249, 250, 251, 0.8);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #f3f4f6;
    }

    .medicine-card .action-button {
      background-color: transparent;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      transition: all 0.2s ease;
    }

    .medicine-card .action-button:hover {
      background-color: #f9fafb;
      border-color: #d1d5db;
    }

    .medicine-card .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1;
    }

    .medicine-card .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .medicine-card .info-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.25rem 0;
    }

    .medicine-card .icon-text {
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    /* Improved spacing and alignment */
    .medicine-card .p-6 > * + * {
      margin-top: 1rem;
    }

    .medicine-card .mb-4:last-child {
      margin-bottom: 0;
    }

    /* Better visual hierarchy */
    .medicine-card .section-divider {
      border-top: 1px solid #f3f4f6;
      padding-top: 1rem;
      margin-top: 1rem;
    }

    /* Enhanced button styling */
    .medicine-card button {
      font-weight: 500;
      letter-spacing: 0.025em;
    }

    .medicine-card .quantity-controls {
      background: linear-gradient(145deg, #f8fafc, #f1f5f9);
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .medicine-card .quantity-controls button {
      border: none;
      background: transparent;
      transition: all 0.2s ease;
    }

    .medicine-card .quantity-controls button:hover {
      background-color: rgba(0, 179, 134, 0.1);
      color: var(--primary);
    }

    .medicine-card .quantity-display {
      background: white;
      border-left: 1px solid #e2e8f0;
      border-right: 1px solid #e2e8f0;
      min-width: 3rem;
      text-align: center;
      font-weight: 600;
      color: #374151;
    }

    /* Sort Dropdown Animation */
    .sort-dropdown {
      animation: dropdownAppear 0.3s ease;
      transform-origin: top right;
    }

    @keyframes dropdownAppear {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Filter Sidebar Animation */
    .filter-sidebar {
      animation: sidebarSlide 0.3s ease;
    }

    @keyframes sidebarSlide {
      from {
        transform: translateX(-100%);
      }
      to {
        transform: translateX(0);
      }
    }

    /* Price Range Slider */
    .price-slider {
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      background: #e2e8f0;
      border-radius: 4px;
      outline: none;
    }

    .price-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .price-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 10px rgba(0,179,134,0.3);
    }

    /* Cart Badge Animation */
    .cart-badge {
      animation: cartBadgePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes cartBadgePop {
      0% { transform: scale(0); }
      100% { transform: scale(1); }
    }

    .toast {
      animation: toastSlide 0.5s ease forwards;
    }

    @keyframes toastSlide {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-teal-500 to-green-500 text-white shadow-lg">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <button onclick="window.location.href='dashboard.html'" 
                class="flex items-center space-x-2 hover:bg-white/10 px-3 py-2 rounded-lg transition-all duration-300">
          <i class="material-icons">arrow_back</i>
          <span class="font-medium">Back</span>
        </button>
        <h1 class="text-2xl font-bold">Browse Medicines</h1>
        <div class="flex items-center gap-4">
          <button id="voiceAssistantBtn" onclick="toggleVoiceAssistant()" 
                  class="flex items-center space-x-2 hover:bg-white/10 px-3 py-2 rounded-lg transition-all duration-300">
            <i class="material-icons">mic</i>
            <span class="font-medium">AI Assistant</span>
          </button>
          <button onclick="window.location.href='prescription-verify.html'" 
                  class="flex items-center space-x-2 hover:bg-white/10 px-3 py-2 rounded-lg transition-all duration-300">
            <i class="material-icons">description</i>
            <span class="font-medium">Verify Prescription</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-6">
    <!-- Search and Filters Row -->
    <div class="flex flex-col md:flex-row gap-4 mb-8">
      <!-- Search Bar -->
      <div class="search-container flex-grow">
        <div class="relative">
          <input type="text" 
                 placeholder="Search medicines, categories, symptoms..." 
                 class="w-full p-4 pl-12 rounded-xl border-2 border-gray-100 focus:border-teal-500 focus:ring-2 focus:ring-teal-200 transition-all duration-300 bg-white/80 backdrop-blur-sm shadow-md"
          >
          <i class="material-icons absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">search</i>
        </div>
      </div>

      <!-- Sort Dropdown -->
      <div class="relative">
        <button onclick="toggleSort()" class="bg-white px-4 py-3 rounded-xl shadow-md flex items-center gap-2 hover:bg-gray-50 transition-all duration-300">
          <i class="material-icons text-gray-600">sort</i>
          <span>Sort By</span>
        </button>
        <div id="sortDropdown" class="sort-dropdown hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg z-10">
          <div class="p-2">
            <button data-sort="price-low-high" class="w-full text-left px-4 py-2 rounded-lg hover:bg-teal-50 transition-all duration-300">
              <i class="material-icons text-sm mr-2">arrow_upward</i>Price: Low to High
            </button>
            <button data-sort="price-high-low" class="w-full text-left px-4 py-2 rounded-lg hover:bg-teal-50 transition-all duration-300">
              <i class="material-icons text-sm mr-2">arrow_downward</i>Price: High to Low
            </button>
            <button data-sort="popularity" class="w-full text-left px-4 py-2 rounded-lg hover:bg-teal-50 transition-all duration-300">
              <i class="material-icons text-sm mr-2">trending_up</i>Popularity
            </button>
            <button data-sort="latest" class="w-full text-left px-4 py-2 rounded-lg hover:bg-teal-50 transition-all duration-300">
              <i class="material-icons text-sm mr-2">new_releases</i>Latest
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Button (Mobile) -->
      <button onclick="toggleFilters()" class="md:hidden bg-white px-4 py-3 rounded-xl shadow-md flex items-center gap-2 hover:bg-gray-50 transition-all duration-300">
        <i class="material-icons text-gray-600">filter_list</i>
        <span>Filters</span>
      </button>
    </div>

    <!-- Top Categories Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
          <i class="material-icons text-teal-500">apps</i>
          Shop by Category
        </h2>
        <button class="text-teal-600 hover:text-teal-700 text-sm font-medium flex items-center gap-1">
          View All <i class="material-icons text-sm">arrow_forward</i>
        </button>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        <!-- Category Item -->
        <div class="category-item bg-gradient-to-br from-red-50 to-pink-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-red-100">
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-red-500">healing</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Pain Relief</h3>
          <p class="text-xs text-gray-500">8 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-blue-100">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-blue-500">ac_unit</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Cold & Flu</h3>
          <p class="text-xs text-gray-500">6 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-pink-50 to-rose-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-pink-100">
          <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-pink-500">face</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Skin Care</h3>
          <p class="text-xs text-gray-500">12 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-yellow-50 to-orange-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-yellow-100">
          <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-yellow-600">child_care</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Baby Care</h3>
          <p class="text-xs text-gray-500">12 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-green-100">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-green-500">science</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Vitamins</h3>
          <p class="text-xs text-gray-500">15 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-purple-50 to-violet-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-purple-100">
          <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-purple-500">woman</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Women's Health</h3>
          <p class="text-xs text-gray-500">7 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-indigo-100">
          <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-indigo-500">spa</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Ayurvedic</h3>
          <p class="text-xs text-gray-500">9 products</p>
        </div>

        <div class="category-item bg-gradient-to-br from-teal-50 to-green-50 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-300 cursor-pointer border border-teal-100">
          <div class="w-12 h-12 bg-teal-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="material-icons text-teal-500">medical_services</i>
          </div>
          <h3 class="text-sm font-medium text-gray-800 mb-1">Devices</h3>
          <p class="text-xs text-gray-500">8 products</p>
        </div>
      </div>
    </div>

    <!-- Featured Deals Section -->
    <div class="bg-gradient-to-r from-orange-400 to-pink-500 rounded-xl shadow-lg p-6 mb-8 text-white">
      <div class="flex items-center justify-between">
        <div class="flex-1">
          <h2 class="text-2xl font-bold mb-2">ðŸ”¥ Limited Time Offers</h2>
          <p class="text-orange-100 mb-4">Up to 50% OFF on selected medicines & health products</p>
          <div class="flex items-center gap-4">
            <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
              <i class="material-icons text-sm mr-1">local_offer</i>
              Free Delivery
            </div>
            <div class="bg-white/20 px-3 py-1 rounded-full text-sm">
              <i class="material-icons text-sm mr-1">timer</i>
              Ends in 2 days
            </div>
          </div>
        </div>
        <div class="text-right">
          <button class="bg-white text-orange-500 px-6 py-3 rounded-lg font-semibold hover:bg-orange-50 transition-all duration-300">
            Shop Now
          </button>
        </div>
      </div>
    </div>

    <!-- Trending Products Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
          <i class="material-icons text-orange-500">trending_up</i>
          Trending Now
        </h2>
        <button class="text-orange-600 hover:text-orange-700 text-sm font-medium flex items-center gap-1">
          View All <i class="material-icons text-sm">arrow_forward</i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Trending Product 1 -->
        <div class="trending-product bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-xl border border-orange-100 hover:shadow-lg transition-all duration-300 cursor-pointer">
          <div class="flex items-center justify-between mb-3">
            <div class="trending-badge">
              <i class="material-icons text-xs">trending_up</i>
              #1 Trending
            </div>
            <div class="text-xs text-gray-500">85% bought</div>
          </div>
          <div class="text-center mb-3">
            <i class="fas fa-pills text-3xl text-orange-500 mb-2"></i>
            <h3 class="font-semibold text-gray-800">Paracetamol</h3>
            <p class="text-xs text-gray-600">Pain Relief</p>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-orange-600">â‚¹49.99</span>
            <button class="bg-orange-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-orange-600 transition-all">
              Quick Add
            </button>
          </div>
        </div>

        <!-- Trending Product 2 -->
        <div class="trending-product bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-100 hover:shadow-lg transition-all duration-300 cursor-pointer">
          <div class="flex items-center justify-between mb-3">
            <div class="trending-badge">
              <i class="material-icons text-xs">trending_up</i>
              #2 Trending
            </div>
            <div class="text-xs text-gray-500">78% bought</div>
          </div>
          <div class="text-center mb-3">
            <i class="fas fa-pills text-3xl text-blue-500 mb-2"></i>
            <h3 class="font-semibold text-gray-800">Hand Sanitizer</h3>
            <p class="text-xs text-gray-600">Personal Hygiene</p>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-blue-600">â‚¹149.99</span>
            <button class="bg-blue-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-600 transition-all">
              Quick Add
            </button>
          </div>
        </div>

        <!-- Trending Product 3 -->
        <div class="trending-product bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-100 hover:shadow-lg transition-all duration-300 cursor-pointer">
          <div class="flex items-center justify-between mb-3">
            <div class="trending-badge">
              <i class="material-icons text-xs">trending_up</i>
              #3 Trending
            </div>
            <div class="text-xs text-gray-500">72% bought</div>
          </div>
          <div class="text-center mb-3">
            <i class="fas fa-pills text-3xl text-green-500 mb-2"></i>
            <h3 class="font-semibold text-gray-800">Vitamin D3</h3>
            <p class="text-xs text-gray-600">Vitamins</p>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-green-600">â‚¹249.99</span>
            <button class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-green-600 transition-all">
              Quick Add
            </button>
          </div>
        </div>

        <!-- Trending Product 4 -->
        <div class="trending-product bg-gradient-to-br from-purple-50 to-violet-50 p-4 rounded-xl border border-purple-100 hover:shadow-lg transition-all duration-300 cursor-pointer">
          <div class="flex items-center justify-between mb-3">
            <div class="trending-badge">
              <i class="material-icons text-xs">trending_up</i>
              #4 Trending
            </div>
            <div class="text-xs text-gray-500">68% bought</div>
          </div>
          <div class="text-center mb-3">
            <i class="fas fa-pills text-3xl text-purple-500 mb-2"></i>
            <h3 class="font-semibold text-gray-800">Baby Lotion</h3>
            <p class="text-xs text-gray-600">Baby Care</p>
          </div>
          <div class="flex items-center justify-between">
            <span class="font-bold text-purple-600">â‚¹199.99</span>
            <button class="bg-purple-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-purple-600 transition-all">
              Quick Add
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart Inventory Management Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-xl font-semibold mb-6 flex items-center gap-2">
        <i class="material-icons text-teal-500">inventory</i>
        Smart Inventory Management
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Stock Levels -->
        <div class="space-y-3">
          <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
            <span class="text-green-700 font-medium">High Stock</span>
            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm" id="highStock">Loading...</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
            <span class="text-yellow-700 font-medium">Medium Stock</span>
            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm" id="mediumStock">Loading...</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
            <span class="text-red-700 font-medium">Low Stock</span>
            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm" id="lowStock">Loading...</span>
          </div>
        </div>

        <!-- Real-time Statistics -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-medium text-gray-800 mb-4">Real-time Statistics</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Total Medicines</span>
              <span class="font-semibold" id="totalMedicines">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Low Stock Items</span>
              <span class="font-semibold text-yellow-600" id="lowStockItems">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Out of Stock</span>
              <span class="font-semibold text-red-600" id="outOfStock">Loading...</span>
            </div>
          </div>
        </div>

        <!-- Nearby Pharmacies -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h3 class="font-medium text-gray-800 mb-4 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">local_pharmacy</i>
            Nearby Pharmacies
          </h3>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">Loading...</span>
              <span class="text-teal-600 font-medium">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Estimates -->
      <div class="bg-gradient-to-r from-teal-50 to-green-50 rounded-lg p-4">
        <h3 class="font-medium text-gray-800 mb-4">Delivery Estimates</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="flex items-center gap-3">
            <i class="material-icons text-teal-500">flash_on</i>
            <div>
              <div class="font-medium text-gray-800">Express Delivery</div>
              <div class="text-sm text-gray-600">10-15 mins</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <i class="material-icons text-blue-500">local_shipping</i>
            <div>
              <div class="font-medium text-gray-800">Standard Delivery</div>
              <div class="text-sm text-gray-600">30-45 mins</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <i class="material-icons text-orange-500">schedule</i>
            <div>
              <div class="font-medium text-gray-800">Current Load</div>
              <div class="text-sm text-orange-600">Medium</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Enhanced Filters Sidebar -->
      <div id="filterSidebar" class="filter-sidebar hidden lg:block w-full lg:w-80 bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
          <i class="material-icons text-teal-500">tune</i>
          Filters
        </h3>

        <!-- Price Range -->
        <div class="mb-6">
          <h4 class="font-medium mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">attach_money</i>
            Price Range
          </h4>
          <input type="range" class="price-slider w-full mb-2" min="0" max="1000" step="10" value="1000">
          <div class="flex justify-between text-sm text-gray-600">
            <span>â‚¹0</span>
            <span id="priceValue">â‚¹1000</span>
          </div>
        </div>

        <!-- Categories -->
        <div class="mb-6">
          <h4 class="font-medium mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">category</i>
            Categories
          </h4>
          <div class="space-y-2 max-h-96 overflow-y-auto">
            <!-- OTC Medicines -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">OTC Medicines</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="pain-relief" data-category="Pain Relief" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-red-500">healing</i>
                  <span class="flex-grow text-sm">Pain Relief</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">8</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="fever-cold" data-category="Fever & Cold" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-blue-500">ac_unit</i>
                  <span class="flex-grow text-sm">Fever & Cold</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">6</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="allergy-relief" data-category="Allergy Relief" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-orange-500">masks</i>
                  <span class="flex-grow text-sm">Allergy Relief</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">5</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="digestive-health" data-category="Digestive Health" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-green-500">restaurant</i>
                  <span class="flex-grow text-sm">Digestive Health</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">7</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="respiratory" data-category="Respiratory" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-cyan-500">air</i>
                  <span class="flex-grow text-sm">Respiratory Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">4</span>
                </label>
              </div>
            </div>

            <!-- Personal Care -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Personal Care</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="skin-care" data-category="Skin Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-pink-500">face</i>
                  <span class="flex-grow text-sm">Skin Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">12</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="hair-care" data-category="Hair Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-purple-500">face_retouching_natural</i>
                  <span class="flex-grow text-sm">Hair Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">8</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="oral-care" data-category="Oral Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-blue-500">sentiment_satisfied</i>
                  <span class="flex-grow text-sm">Oral Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">6</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="personal-hygiene" data-category="Personal Hygiene" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-teal-500">clean_hands</i>
                  <span class="flex-grow text-sm">Personal Hygiene</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">10</span>
                </label>
              </div>
            </div>

            <!-- Health Conditions -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Health Conditions</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="diabetes-care" data-category="Diabetes Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-red-500">bloodtype</i>
                  <span class="flex-grow text-sm">Diabetes Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">5</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="blood-pressure" data-category="Blood Pressure" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-red-600">favorite</i>
                  <span class="flex-grow text-sm">Blood Pressure</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">4</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="heart-health" data-category="Heart Health" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-red-500">monitor_heart</i>
                  <span class="flex-grow text-sm">Heart Health</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">3</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="cholesterol" data-category="Cholesterol" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-orange-500">analytics</i>
                  <span class="flex-grow text-sm">Cholesterol</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">2</span>
                </label>
              </div>
            </div>

            <!-- Vitamins & Supplements -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Nutrition</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="vitamins-supplements" data-category="Vitamins & Supplements" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-yellow-500">science</i>
                  <span class="flex-grow text-sm">Vitamins & Supplements</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">15</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="protein-fitness" data-category="Protein & Fitness" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-orange-500">fitness_center</i>
                  <span class="flex-grow text-sm">Protein & Fitness</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">8</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="immunity-boosters" data-category="Immunity Boosters" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-green-500">shield</i>
                  <span class="flex-grow text-sm">Immunity Boosters</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">6</span>
                </label>
              </div>
            </div>

            <!-- Specialized Care -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Specialized Care</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="womens-health" data-category="Women's Health" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-pink-500">woman</i>
                  <span class="flex-grow text-sm">Women's Health</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">7</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="mens-health" data-category="Men's Health" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-blue-500">man</i>
                  <span class="flex-grow text-sm">Men's Health</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">5</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="baby-care" data-category="Baby Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-yellow-500">child_care</i>
                  <span class="flex-grow text-sm">Baby Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">12</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="senior-care" data-category="Senior Care" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-gray-500">elderly</i>
                  <span class="flex-grow text-sm">Senior Care</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">4</span>
                </label>
              </div>
            </div>

            <!-- Alternative Medicine -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Alternative Medicine</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="ayurvedic" data-category="Ayurvedic" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-green-600">spa</i>
                  <span class="flex-grow text-sm">Ayurvedic</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">9</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="homeopathy" data-category="Homeopathy" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-blue-600">local_florist</i>
                  <span class="flex-grow text-sm">Homeopathy</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">6</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="herbal" data-category="Herbal" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-green-500">eco</i>
                  <span class="flex-grow text-sm">Herbal</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">7</span>
                </label>
              </div>
            </div>

            <!-- Medical Devices -->
            <div class="mb-3">
              <h5 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Devices & Equipment</h5>
              <div class="space-y-1">
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="medical-devices" data-category="Medical Devices" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-gray-600">medical_services</i>
                  <span class="flex-grow text-sm">Medical Devices</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">8</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
                  <input type="checkbox" value="first-aid" data-category="First Aid" class="form-checkbox text-teal-500 rounded">
                  <i class="material-icons text-sm text-red-500">healing</i>
                  <span class="flex-grow text-sm">First Aid</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">5</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Availability -->
        <div class="mb-6">
          <h4 class="font-medium mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">inventory_2</i>
            Availability
          </h4>
          <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
            <input type="checkbox" value="inStockOnly" class="form-checkbox text-teal-500 rounded">
            <span>In Stock Only</span>
          </label>
        </div>

        <!-- Prescription Required -->
        <div class="mb-6">
          <h4 class="font-medium mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">description</i>
            Prescription
          </h4>
          <label class="flex items-center gap-3 cursor-pointer p-2 rounded-lg hover:bg-gray-50 transition-all">
            <input type="checkbox" value="noPrescriptionNeeded" class="form-checkbox text-teal-500 rounded">
            <span>No Prescription Needed</span>
          </label>
        </div>

        <!-- Clear Filters Button -->
        <button onclick="clearFilters()" class="w-full bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 px-4 py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 font-medium">
          <i class="material-icons text-sm">clear_all</i>
          <span>Clear All Filters</span>
        </button>
      </div>

      <!-- Medicine Grid -->
      <div class="flex-grow">
        <!-- Enhanced Loading State -->
        <div id="loadingState" class="hidden">
          <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="text-center">
              <div class="animate-spin rounded-full h-16 w-16 border-4 border-t-teal-500 border-gray-200 mx-auto mb-4"></div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">Loading...</h3>
              <p class="text-gray-500 mb-4">Checking stock...</p>
              <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                <div class="bg-teal-500 h-2 rounded-full animate-pulse" style="width: 0%" id="loadingProgress"></div>
              </div>
              <div class="grid grid-cols-3 gap-4 text-sm text-gray-600">
                <div>
                  <div class="font-medium">Current Stock:</div>
                  <div>Loading...</div>
                </div>
                <div>
                  <div class="font-medium">Reserved:</div>
                  <div>Loading...</div>
                </div>
                <div>
                  <div class="font-medium">Last Updated:</div>
                  <div>Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden">
          <div class="bg-white rounded-xl shadow-lg p-8 text-center">
            <i class="material-icons text-red-500 text-6xl mb-4">error_outline</i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Unable to Load Medicines</h3>
            <p class="text-gray-500 mb-6" id="errorMessage">Please check your internet connection and try again</p>
            <button onclick="retryLoading()" class="inline-flex items-center gap-2 bg-teal-500 text-white px-6 py-3 rounded-lg hover:bg-teal-600 transition-all">
              <i class="material-icons">refresh</i>
              Retry Loading
            </button>
          </div>
        </div>

        <!-- Medicine Grid -->
        <div id="medicineGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          <!-- Medicine cards will be dynamically inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modern Floating Action Buttons -->
  <div class="floating-actions">
    <!-- Cart Button -->
    <button onclick="goToCart()" class="floating-btn bg-gradient-to-r from-teal-500 to-green-500 text-white relative">
      <i class="material-icons">shopping_cart</i>
      <span class="notification-badge" id="cartFloatingBadge">0</span>
    </button>
    
    <!-- Compare Button -->
    <button onclick="toggleCompare()" class="floating-btn bg-gradient-to-r from-blue-500 to-indigo-500 text-white relative">
      <i class="material-icons">compare_arrows</i>
      <span class="notification-badge hidden" id="compareBadge">0</span>
    </button>
    
    <!-- Wishlist Button -->
    <button onclick="toggleWishlist()" class="floating-btn bg-gradient-to-r from-pink-500 to-red-500 text-white relative">
      <i class="material-icons">favorite</i>
      <span class="notification-badge hidden" id="wishlistBadge">0</span>
    </button>
    
    <!-- Call Pharmacy Button -->
    <button onclick="callNearestPharmacy()" class="floating-btn bg-gradient-to-r from-orange-500 to-yellow-500 text-white">
      <i class="material-icons">phone</i>
    </button>
    
    <!-- Emergency Button -->
    <button onclick="emergencyServices()" class="floating-btn bg-gradient-to-r from-red-600 to-red-700 text-white animate-pulse">
      <i class="material-icons">emergency</i>
    </button>
  </div>

  <!-- Voice Assistant Modal -->
  <div id="voiceAssistantModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gradient-to-r from-teal-500 to-green-500 rounded-full flex items-center justify-center">
              <i class="material-icons text-white">smart_toy</i>
            </div>
            <div>
              <h2 class="text-xl font-semibold">MediQuick AI Assistant</h2>
              <p class="text-sm text-gray-500">Ask me about medicines, symptoms, or health queries</p>
            </div>
          </div>
          <button onclick="closeVoiceAssistant()" class="text-gray-400 hover:text-gray-600 transition-all">
            <i class="material-icons">close</i>
          </button>
        </div>

        <!-- Voice Controls -->
        <div class="text-center mb-6">
          <button id="startListeningBtn" onclick="startListening()" 
                  class="w-20 h-20 bg-gradient-to-r from-teal-500 to-green-500 rounded-full flex items-center justify-center text-white shadow-lg hover:shadow-xl transition-all duration-300 mx-auto mb-4">
            <i class="material-icons text-3xl" id="micIcon">mic</i>
          </button>
          <p class="text-gray-600" id="listeningStatus">Click to start speaking</p>
          <div class="mt-2">
            <div id="audioVisualizer" class="hidden flex justify-center items-center gap-1">
              <div class="w-1 bg-teal-500 rounded-full animate-pulse" style="height: 20px;"></div>
              <div class="w-1 bg-teal-500 rounded-full animate-pulse" style="height: 30px; animation-delay: 0.1s;"></div>
              <div class="w-1 bg-teal-500 rounded-full animate-pulse" style="height: 25px; animation-delay: 0.2s;"></div>
              <div class="w-1 bg-teal-500 rounded-full animate-pulse" style="height: 35px; animation-delay: 0.3s;"></div>
              <div class="w-1 bg-teal-500 rounded-full animate-pulse" style="height: 20px; animation-delay: 0.4s;"></div>
            </div>
          </div>
        </div>

        <!-- Transcription Display -->
        <div class="mb-6">
          <h3 class="font-medium text-gray-800 mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">hearing</i>
            What I heard:
          </h3>
          <div id="transcriptionDisplay" class="bg-gray-50 rounded-lg p-4 min-h-[60px] text-gray-600 italic">
            Your speech will appear here...
          </div>
        </div>

        <!-- AI Response -->
        <div class="mb-6">
          <h3 class="font-medium text-gray-800 mb-3 flex items-center gap-2">
            <i class="material-icons text-sm text-gray-500">psychology</i>
            AI Response:
          </h3>
          <div id="aiResponseDisplay" class="bg-gradient-to-r from-teal-50 to-green-50 rounded-lg p-4 min-h-[100px]">
            <div id="responseContent" class="text-gray-600 italic">Ask me anything about medicines...</div>
            <div id="responseActions" class="hidden mt-4 flex gap-2">
              <button onclick="speakResponse()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                <i class="material-icons text-sm">volume_up</i>
                Speak Response
              </button>
              <button onclick="copyResponse()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                <i class="material-icons text-sm">content_copy</i>
                Copy
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="border-t pt-4">
          <h4 class="font-medium text-gray-800 mb-3">Quick Questions:</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <button onclick="askQuickQuestion('What is paracetamol used for?')" 
                    class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all text-sm">
              "What is paracetamol used for?"
            </button>
            <button onclick="askQuickQuestion('Side effects of ibuprofen')" 
                    class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all text-sm">
              "Side effects of ibuprofen"
            </button>
            <button onclick="askQuickQuestion('Can I take aspirin with food?')" 
                    class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all text-sm">
              "Can I take aspirin with food?"
            </button>
            <button onclick="askQuickQuestion('What helps with allergies?')" 
                    class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all text-sm">
              "What helps with allergies?"
            </button>
          </div>
        </div>

        <!-- Disclaimer -->
        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex items-start gap-2">
            <i class="material-icons text-yellow-600 text-sm mt-0.5">warning</i>
            <div class="text-sm text-yellow-800">
              <strong>Medical Disclaimer:</strong> This information is for educational purposes only and is not a substitute for professional medical advice. Always consult with a healthcare provider for medical concerns.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Cart state management with proper initialization
    let cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    let wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
    let compareItems = JSON.parse(localStorage.getItem('compareItems') || '[]');

    // Ensure cart data integrity
    function initializeCartData() {
      try {
        const storedCart = localStorage.getItem('cartItems');
        if (storedCart) {
          cartItems = JSON.parse(storedCart);
          // Ensure all cart items have required properties
          cartItems = cartItems.map(item => ({
            ...item,
            quantity: item.quantity || 1,
            id: item.id || Math.random().toString(36).substr(2, 9)
          }));
        }
        console.log('Cart initialized with', cartItems.length, 'items');
      } catch (error) {
        console.error('Error loading cart data:', error);
        cartItems = [];
      }
    }

    // Initialize cart data on load
    initializeCartData();

    const updateCartBadge = () => {
      const floatingBadge = document.getElementById('cartFloatingBadge');
      const totalQuantity = cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
      
      if (floatingBadge) {
        floatingBadge.textContent = totalQuantity;
        floatingBadge.style.display = totalQuantity > 0 ? 'flex' : 'none';
      }
      
      // Also update any other cart badges that might exist
      const allCartBadges = document.querySelectorAll('.cart-badge, .notification-badge');
      allCartBadges.forEach(badge => {
        if (badge.id === 'cartFloatingBadge' || badge.classList.contains('cart-badge')) {
          badge.textContent = totalQuantity;
          badge.style.display = totalQuantity > 0 ? 'flex' : 'none';
        }
      });
      
      console.log('Cart updated:', { totalQuantity, cartItems }); // Debug log
    };

    // Update medicine quantity in the card
    function updateMedicineQuantity(button, change) {
      const quantitySpan = button.parentElement.querySelector('span');
      let quantity = parseInt(quantitySpan.textContent);
      quantity = Math.max(1, quantity + change);
      quantitySpan.textContent = quantity;
    }

    // Additional medicine information
    const medicineInfo = {
      'Paracetamol': {
        uses: 'Relief from fever, headache, and various body pains',
        sideEffects: 'Rare side effects may include liver problems, skin rashes',
        dosage: 'Adults: 1-2 tablets every 4-6 hours as needed',
        warnings: 'Do not exceed 8 tablets in 24 hours. Avoid alcohol.'
      },
      'Ibuprofen': {
        uses: 'Relief from pain, inflammation, and fever',
        sideEffects: 'May cause stomach upset, heartburn, dizziness',
        dosage: 'Adults: 200-400mg every 4-6 hours',
        warnings: 'Take with food. Not recommended for stomach ulcer patients.'
      },
      'Metformin': {
        uses: 'Control blood sugar levels in type 2 diabetes',
        sideEffects: 'Nausea, diarrhea, stomach upset',
        dosage: 'As prescribed by your doctor',
        warnings: 'Prescription only. Regular blood sugar monitoring required.'
      },
      'Aspirin': {
        uses: 'Pain relief, fever reduction, heart attack prevention',
        sideEffects: 'Stomach upset, increased bleeding risk',
        dosage: 'Adults: 300-900mg every 4-6 hours',
        warnings: 'Not recommended for people with bleeding disorders.'
      },
      'Cetirizine': {
        uses: 'Relief from allergy symptoms like sneezing and itching',
        sideEffects: 'Drowsiness, dry mouth',
        dosage: 'Adults and children over 12: 10mg once daily',
        warnings: 'May cause drowsiness. Avoid alcohol.'
      },
      'Omeprazole': {
        uses: 'Treatment of acid reflux and stomach ulcers',
        sideEffects: 'Headache, stomach pain, nausea',
        dosage: 'Adults: 20mg once daily',
        warnings: 'Take on empty stomach. Complete prescribed course.'
      }
    };

    // Show medicine details with additional information
    function showMedicineDetails(medicineCard) {
      const item = this.mockData.find(item => 
        item.medicine.name === medicineCard.querySelector('h3').textContent
      );

      if (!item) return;

      const { medicine, quantity, status, pharmacy } = item;
      const popup = document.createElement('div');
      popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      popup.innerHTML = `
        <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <!-- Header Section -->
            <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
              <div class="flex-1">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">${medicine.name}</h2>
                <div class="flex items-center gap-4 text-gray-600">
                  <span class="text-lg font-medium">${medicine.brandName}</span>
                  <span class="text-sm px-3 py-1 bg-gray-100 rounded-full">${medicine.category}</span>
                  <span class="text-sm px-3 py-1 bg-teal-100 text-teal-700 rounded-full">${medicine.dosage}</span>
                </div>
              </div>
              <button onclick="this.closest('.fixed').remove()" 
                      class="text-gray-400 hover:text-gray-600 transition-all p-2 hover:bg-gray-100 rounded-lg">
                <i class="material-icons">close</i>
              </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
              <!-- Left Column -->
              <div class="space-y-6">
                <!-- Medicine Visual -->
                <div class="bg-gradient-to-br from-teal-50 to-green-50 rounded-xl p-12 flex items-center justify-center border border-teal-100">
                  <i class="fas fa-pills text-9xl text-teal-500"></i>
                </div>

                <!-- Pharmacy Information -->
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200">
                  <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="material-icons text-teal-500">store</i>
                    Pharmacy Information
                  </h3>
                  <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Pharmacy Name</span>
                        <p class="text-gray-900 font-semibold">${pharmacy.name}</p>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Type</span>
                        <p class="text-gray-900 font-semibold">${pharmacy.type}</p>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Distance</span>
                        <p class="text-gray-900 font-semibold">${pharmacy.distance}</p>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Rating</span>
                        <div class="flex items-center">
                          <i class="material-icons text-yellow-400 text-lg mr-1">star</i>
                          <span class="text-gray-900 font-semibold">${pharmacy.rating}/5</span>
                        </div>
                      </div>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600 font-medium">Address</span>
                      <p class="text-gray-900 font-semibold mt-1">${pharmacy.address}</p>
                    </div>
                    <div>
                      <span class="text-sm text-gray-600 font-medium">Established</span>
                      <p class="text-gray-900 font-semibold">${pharmacy.established}</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Right Column -->
              <div class="space-y-6">
                <!-- Medicine Details -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                  <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="material-icons text-blue-500">medical_services</i>
                    Medicine Details
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <span class="text-sm text-gray-600 font-medium">Description</span>
                      <p class="text-gray-900 mt-1 leading-relaxed">${medicine.description}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Manufacturer</span>
                        <p class="text-gray-900 font-semibold">${medicine.manufacturer}</p>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Dosage</span>
                        <p class="text-gray-900 font-semibold">${medicine.dosage}</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Usage & Safety Information -->
                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-6 border border-amber-100">
                  <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="material-icons text-amber-500">health_and_safety</i>
                    Usage & Safety
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                        <i class="material-icons text-xs">info</i>Usage Instructions
                      </h4>
                      <p class="text-gray-900 leading-relaxed bg-white p-3 rounded-lg">${medicine.usage}</p>
                    </div>
                    <div>
                      <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                        <i class="material-icons text-xs">warning</i>Side Effects
                      </h4>
                      <ul class="bg-white p-3 rounded-lg space-y-1">
                        ${medicine.sideEffects.map(effect => 
                          `<li class="text-gray-900 flex items-center gap-2">
                            <i class="material-icons text-xs text-orange-500">fiber_manual_record</i>
                            ${effect}
                          </li>`
                        ).join('')}
                      </ul>
                    </div>
                    <div>
                      <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                        <i class="material-icons text-xs">priority_high</i>Important Warnings
                      </h4>
                      <ul class="bg-white p-3 rounded-lg space-y-1">
                        ${medicine.warnings.map(warning => 
                          `<li class="text-gray-900 flex items-center gap-2">
                            <i class="material-icons text-xs text-red-500">fiber_manual_record</i>
                            ${warning}
                          </li>`
                        ).join('')}
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Purchase Section -->
                <div class="bg-gradient-to-br from-teal-50 to-green-50 rounded-xl p-6 border-2 border-teal-200">
                  <div class="flex items-end justify-between mb-6">
                    <div class="flex-1">
                      <h3 class="font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <i class="material-icons text-teal-500">local_offer</i>
                        Pricing
                      </h3>
                      <div class="flex items-baseline gap-3 mb-2">
                        <span class="text-4xl font-bold text-teal-600">â‚¹${medicine.price}</span>
                        ${medicine.genericAvailable ? 
                          `<span class="text-lg text-gray-500 line-through">â‚¹${(medicine.price * 1.5).toFixed(2)}</span>` : ''}
                      </div>
                      ${medicine.genericAvailable ? 
                        `<p class="text-sm text-blue-600 font-semibold bg-blue-100 px-3 py-1 rounded-full inline-block">
                          Generic available from â‚¹${medicine.genericPrice}
                        </p>` : ''}
                    </div>
                    
                    <div class="flex items-center gap-4 ml-6">
                      <div class="flex items-center bg-white rounded-lg border-2 border-gray-200 shadow-sm">
                        <button class="popup-minus-btn px-4 py-3 text-gray-600 hover:text-teal-600 hover:bg-teal-50 transition-all rounded-l-lg">
                          <i class="material-icons">remove</i>
                        </button>
                        <span class="w-16 text-center py-3 font-bold text-gray-900 bg-gray-50 border-x-2 border-gray-200">1</span>
                        <button class="popup-plus-btn px-4 py-3 text-gray-600 hover:text-teal-600 hover:bg-teal-50 transition-all rounded-r-lg">
                          <i class="material-icons">add</i>
                        </button>
                      </div>
                      <button class="popup-add-to-cart bg-teal-500 hover:bg-teal-600 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center gap-2 font-semibold shadow-lg">
                        <i class="material-icons">add_shopping_cart</i>
                        Add to Cart
                      </button>
                    </div>
                  </div>
                  
                  <!-- Trust Indicators -->
                  <div class="flex items-center justify-between pt-4 border-t border-teal-200">
                    <div class="flex items-center gap-6 text-sm">
                      <div class="flex items-center gap-2">
                        <i class="material-icons text-green-500">verified</i>
                        <span class="text-gray-700 font-medium">Genuine Product</span>
                      </div>
                      <div class="flex items-center gap-2">
                        <i class="material-icons text-blue-500">security</i>
                        <span class="text-gray-700 font-medium">Safe Delivery</span>
                      </div>
                      ${medicine.requiresPrescription ? `
                        <div class="flex items-center gap-2 text-amber-600">
                          <i class="material-icons">description</i>
                          <span class="font-medium">Prescription Required</span>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Store the medicineCard reference for the add to cart functionality
      popup._medicineCard = medicineCard;
      document.body.appendChild(popup);
    }

    class MedicineDisplay {
      constructor() {
        this.currentLocation = null;
        this.retryAttempts = 0;
        this.maxRetries = 3;
        // Updated with real medical shops in Dammaiguda and Nagaram areas
        this.realMedicalShops = [
          {
            name: 'Apollo Pharmacy',
            address: 'Survey No.83, Dammaiguda Main Road, Dammaiguda, Hyderabad, Telangana 500083',
            lat: 17.4542,
            lng: 78.5717,
            phone: '+91 40-44664466',
            rating: 4.6,
            type: 'Chain Pharmacy',
            services: ['Home Delivery', '24/7 Service', 'Online Ordering'],
            established: '2018'
          },
          {
            name: 'MedPlus Pharmacy',
            address: 'Plot No.45, Nagaram Main Road, Near Bus Stop, Nagaram, Hyderabad, Telangana 500082',
            lat: 17.4612,
            lng: 78.5834,
            phone: '+91 40-44887755',
            rating: 4.4,
            type: 'Chain Pharmacy',
            services: ['Home Delivery', 'Digital Prescription', 'Health Checkups'],
            established: '2019'
          },
          {
            name: 'Wellness Forever',
            address: 'H.No.2-56/A, Dammaiguda X Roads, Dammaiguda, Hyderabad, Telangana 500083',
            lat: 17.4528,
            lng: 78.5698,
            phone: '+91 40-42334455',
            rating: 4.3,
            type: 'Chain Pharmacy',
            services: ['Home Delivery', 'Medicine Reminder', 'Senior Citizen Discount'],
            established: '2020'
          },
          {
            name: 'Care Point Pharmacy',
            address: 'Shop No.12, Nagaram Housing Society, Nagaram, Hyderabad, Telangana 500082',
            lat: 17.4598,
            lng: 78.5812,
            phone: '+91 9876543210',
            rating: 4.2,
            type: 'Local Pharmacy',
            services: ['Home Delivery', 'Emergency Service', 'Generic Medicines'],
            established: '2015'
          },
          {
            name: 'LifeCare Medical Store',
            address: 'Plot No.78, Near ECIL Metro Station, Dammaiguda, Hyderabad, Telangana 500083',
            lat: 17.4556,
            lng: 78.5725,
            phone: '+91 9123456789',
            rating: 4.5,
            type: 'Local Pharmacy',
            services: ['Home Delivery', 'Ayurvedic Medicines', 'Health Supplements'],
            established: '2017'
          },
          {
            name: 'Sanjeevani Medical Hall',
            address: 'Beside Nagaram Police Station, Nagaram Main Road, Nagaram, Hyderabad, Telangana 500082',
            lat: 17.4625,
            lng: 78.5845,
            phone: '+91 9876501234',
            rating: 4.1,
            type: 'Local Pharmacy',
            services: ['24/7 Emergency', 'Prescription Verification', 'Cold Chain Storage'],
            established: '2012'
          },
          {
            name: 'Max Care Pharmacy',
            address: 'Shop No.34, Dammaiguda Market Complex, Dammaiguda, Hyderabad, Telangana 500083',
            lat: 17.4535,
            lng: 78.5703,
            phone: '+91 40-43221100',
            rating: 4.3,
            type: 'Local Pharmacy',
            services: ['Home Delivery', 'Insurance Claims', 'Medicine Counseling'],
            established: '2016'
          },
          {
            name: 'Guardian Pharmacy',
            address: 'H.No.5-67, Near Nagaram Temple, Nagaram, Hyderabad, Telangana 500082',
            lat: 17.4587,
            lng: 78.5798,
            phone: '+91 9988776655',
            rating: 4.4,
            type: 'Local Pharmacy',
            services: ['Home Delivery', 'Health Camps', 'Senior Citizen Care'],
            established: '2014'
          }
        ];
        
        this.mockData = [
          // Pain Relief Medicines
          {
            medicine: {
              _id: '1',
              name: 'Paracetamol',
              brandName: 'Crocin',
              category: 'Pain Relief',
              description: 'Effective relief from fever and mild to moderate pain',
              price: 49.99,
              genericAvailable: true,
              genericPrice: 29.99,
              requiresPrescription: false,
              dosage: '500mg',
              manufacturer: 'GSK Healthcare',
              sideEffects: ['Nausea', 'Liver problems in high doses', 'Skin rash'],
              usage: 'Take 1-2 tablets every 4-6 hours as needed',
              warnings: ['Do not exceed 8 tablets in 24 hours', 'Avoid alcohol']
            },
            quantity: 100,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '2',
              name: 'Ibuprofen',
              brandName: 'Brufen',
              category: 'Pain Relief',
              description: 'Reduces inflammation and relieves pain',
              price: 89.99,
              genericAvailable: true,
              genericPrice: 45.99,
              requiresPrescription: false,
              dosage: '400mg',
              manufacturer: 'Abbott',
              sideEffects: ['Stomach upset', 'Heartburn', 'Dizziness'],
              usage: 'Take 1 tablet every 6-8 hours after food',
              warnings: ['Not for stomach ulcer patients', 'Avoid if allergic to aspirin']
            },
            quantity: 50,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '3',
              name: 'Diclofenac',
              brandName: 'Voveran',
              category: 'Pain Relief',
              description: 'Strong pain relief for muscle and joint pain',
              price: 119.99,
              genericAvailable: true,
              genericPrice: 69.99,
              requiresPrescription: true,
              dosage: '50mg',
              manufacturer: 'Novartis',
              sideEffects: ['Stomach ulcers', 'Kidney problems', 'High blood pressure'],
              usage: 'Take with food, 2-3 times daily',
              warnings: ['Not for long-term use', 'Avoid in heart disease']
            },
            quantity: 40,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Cold & Flu Medicines
          {
            medicine: {
              _id: '4',
              name: 'Cetirizine',
              brandName: 'Zyrtec',
              category: 'Fever & Cold',
              description: '24-hour relief from allergy symptoms',
              price: 69.99,
              genericAvailable: true,
              genericPrice: 35.99,
              requiresPrescription: false,
              dosage: '10mg',
              manufacturer: 'UCB Pharma',
              sideEffects: ['Drowsiness', 'Dry mouth', 'Fatigue'],
              usage: 'Take one tablet daily',
              warnings: ['May cause drowsiness', 'Avoid alcohol']
            },
            quantity: 30,
            status: 'LOW_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '5',
              name: 'Cough Syrup',
              brandName: 'Benadryl',
              category: 'Fever & Cold',
              description: 'Relief from dry and wet cough',
              price: 99.99,
              genericAvailable: true,
              genericPrice: 59.99,
              requiresPrescription: false,
              dosage: '10ml',
              manufacturer: 'Johnson & Johnson',
              sideEffects: ['Drowsiness', 'Nausea', 'Dizziness'],
              usage: 'Take 2-3 teaspoons 3 times daily',
              warnings: ['May cause drowsiness', 'Do not drive after taking']
            },
            quantity: 80,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '6',
              name: 'Cold Relief Tablets',
              brandName: 'Sinarest',
              category: 'Fever & Cold',
              description: 'Complete cold and flu relief',
              price: 79.99,
              genericAvailable: true,
              genericPrice: 49.99,
              requiresPrescription: false,
              dosage: '1 tablet',
              manufacturer: 'Centaur Pharmaceuticals',
              sideEffects: ['Drowsiness', 'Dry mouth'],
              usage: 'Take 1 tablet every 8 hours',
              warnings: ['Do not exceed 3 tablets in 24 hours']
            },
            quantity: 65,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Skin Care Products
          {
            medicine: {
              _id: '7',
              name: 'Moisturizing Cream',
              brandName: 'Cetaphil',
              category: 'Skin Care',
              description: 'Daily moisturizer for all skin types',
              price: 299.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '50g',
              manufacturer: 'Galderma',
              sideEffects: ['Rare allergic reactions'],
              usage: 'Apply twice daily on clean skin',
              warnings: ['For external use only', 'Avoid contact with eyes']
            },
            quantity: 45,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '8',
              name: 'Sunscreen SPF 50',
              brandName: 'Neutrogena',
              category: 'Skin Care',
              description: 'Broad spectrum sun protection',
              price: 599.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '100ml',
              manufacturer: 'Johnson & Johnson',
              sideEffects: ['Skin irritation in sensitive individuals'],
              usage: 'Apply 30 minutes before sun exposure',
              warnings: ['Reapply every 2 hours', 'Water resistant']
            },
            quantity: 35,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '9',
              name: 'Anti-Acne Gel',
              brandName: 'Clindac A',
              category: 'Skin Care',
              description: 'Treats acne and prevents new breakouts',
              price: 189.99,
              genericAvailable: true,
              genericPrice: 129.99,
              requiresPrescription: true,
              dosage: '20g',
              manufacturer: 'Cipla',
              sideEffects: ['Skin dryness', 'Mild irritation'],
              usage: 'Apply thin layer twice daily',
              warnings: ['Avoid sun exposure', 'Use moisturizer']
            },
            quantity: 25,
            status: 'LOW_STOCK',
            pharmacy: null
          },

          // Baby Care Products
          {
            medicine: {
              _id: '10',
              name: 'Baby Lotion',
              brandName: 'Johnson\'s Baby',
              category: 'Baby Care',
              description: 'Gentle moisturizing lotion for babies',
              price: 199.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '200ml',
              manufacturer: 'Johnson & Johnson',
              sideEffects: [],
              usage: 'Apply gently after bath',
              warnings: ['For external use only', 'Avoid contact with eyes']
            },
            quantity: 60,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '11',
              name: 'Baby Shampoo',
              brandName: 'Johnson\'s Baby',
              category: 'Baby Care',
              description: 'No more tears formula',
              price: 149.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '200ml',
              manufacturer: 'Johnson & Johnson',
              sideEffects: [],
              usage: 'Apply to wet hair, lather and rinse',
              warnings: ['For external use only', 'If irritation occurs, discontinue use']
            },
            quantity: 75,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '12',
              name: 'Baby Powder',
              brandName: 'Johnson\'s Baby',
              category: 'Baby Care',
              description: 'Keeps baby\'s skin dry and comfortable',
              price: 129.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '100g',
              manufacturer: 'Johnson & Johnson',
              sideEffects: [],
              usage: 'Sprinkle on hands and apply gently',
              warnings: ['Keep away from baby\'s face', 'Avoid inhalation']
            },
            quantity: 90,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Vitamins & Supplements
          {
            medicine: {
              _id: '13',
              name: 'Multivitamin',
              brandName: 'Revital',
              category: 'Vitamins & Supplements',
              description: 'Complete nutrition with essential vitamins and minerals',
              price: 299.99,
              genericAvailable: true,
              genericPrice: 199.99,
              requiresPrescription: false,
              dosage: '1 Tablet',
              manufacturer: 'Ranbaxy',
              sideEffects: ['Mild stomach upset', 'Metallic taste'],
              usage: 'Take one tablet daily after breakfast',
              warnings: ['Do not exceed one tablet per day', 'Store in cool place']
            },
            quantity: 120,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '14',
              name: 'Vitamin D3',
              brandName: 'Calcirol',
              category: 'Vitamins & Supplements',
              description: 'Essential for bone health and immunity',
              price: 249.99,
              genericAvailable: true,
              genericPrice: 149.99,
              requiresPrescription: false,
              dosage: '60000 IU',
              manufacturer: 'Cadila Healthcare',
              sideEffects: ['Nausea', 'Kidney stones with overdose'],
              usage: 'Take once weekly with food',
              warnings: ['Do not exceed recommended dose', 'Regular monitoring advised']
            },
            quantity: 45,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '15',
              name: 'Iron Tablets',
              brandName: 'Feroglobin',
              category: 'Vitamins & Supplements',
              description: 'Iron supplement for anemia and iron deficiency',
              price: 199.99,
              genericAvailable: true,
              genericPrice: 119.99,
              requiresPrescription: false,
              dosage: '200mg',
              manufacturer: 'Vitabiotics',
              sideEffects: ['Constipation', 'Dark stools', 'Stomach upset'],
              usage: 'Take one tablet daily on empty stomach',
              warnings: ['Take with vitamin C for better absorption', 'Keep away from children']
            },
            quantity: 85,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '16',
              name: 'Calcium + Vitamin D',
              brandName: 'Shelcal',
              category: 'Vitamins & Supplements',
              description: 'Bone health supplement with calcium and vitamin D',
              price: 179.99,
              genericAvailable: true,
              genericPrice: 119.99,
              requiresPrescription: false,
              dosage: '500mg + 250 IU',
              manufacturer: 'Torrent Pharmaceuticals',
              sideEffects: ['Constipation', 'Kidney stones', 'Gas'],
              usage: 'Take one tablet twice daily with meals',
              warnings: ['Drink plenty of water', 'Do not take with iron tablets']
            },
            quantity: 65,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Women's Health
          {
            medicine: {
              _id: '17',
              name: 'Iron + Folic Acid',
              brandName: 'IFA Tablets',
              category: 'Women\'s Health',
              description: 'Essential supplement for pregnant and lactating women',
              price: 149.99,
              genericAvailable: true,
              genericPrice: 89.99,
              requiresPrescription: false,
              dosage: '100mg + 500mcg',
              manufacturer: 'Various',
              sideEffects: ['Nausea', 'Constipation', 'Dark stools'],
              usage: 'Take one tablet daily with food',
              warnings: ['Do not take with tea or coffee', 'Continue as advised by doctor']
            },
            quantity: 70,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '18',
              name: 'Pregnancy Test Kit',
              brandName: 'Prega News',
              category: 'Women\'s Health',
              description: 'Home pregnancy test kit with 99% accuracy',
              price: 99.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '1 Test',
              manufacturer: 'Mankind Pharma',
              sideEffects: [],
              usage: 'Follow instructions on package',
              warnings: ['Use first morning urine', 'Check expiry date']
            },
            quantity: 25,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Ayurvedic Products
          {
            medicine: {
              _id: '19',
              name: 'Chyawanprash',
              brandName: 'Dabur',
              category: 'Ayurvedic',
              description: 'Immunity booster with 40+ herbs',
              price: 399.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '500g',
              manufacturer: 'Dabur',
              sideEffects: [],
              usage: 'Take 1-2 teaspoons daily with milk',
              warnings: ['Store in cool dry place', 'Diabetics consult doctor']
            },
            quantity: 55,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '20',
              name: 'Triphala Churna',
              brandName: 'Patanjali',
              category: 'Ayurvedic',
              description: 'Natural digestive and detox supplement',
              price: 159.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '100g',
              manufacturer: 'Patanjali',
              sideEffects: ['Mild loose stools initially'],
              usage: 'Take 1 teaspoon with warm water before bed',
              warnings: ['Start with smaller dose', 'Pregnant women avoid']
            },
            quantity: 40,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Medical Devices
          {
            medicine: {
              _id: '21',
              name: 'Digital Thermometer',
              brandName: 'Omron',
              category: 'Medical Devices',
              description: 'Digital thermometer for accurate temperature reading',
              price: 299.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: 'Device',
              manufacturer: 'Omron',
              sideEffects: [],
              usage: 'Place under tongue or armpit for 1 minute',
              warnings: ['Clean before and after use', 'Handle with care']
            },
            quantity: 20,
            status: 'LOW_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '22',
              name: 'Blood Pressure Monitor',
              brandName: 'Omron',
              category: 'Medical Devices',
              description: 'Automatic blood pressure monitor',
              price: 2499.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: 'Device',
              manufacturer: 'Omron',
              sideEffects: [],
              usage: 'Follow instruction manual',
              warnings: ['Regular calibration required', '2 year warranty']
            },
            quantity: 15,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Personal Hygiene
          {
            medicine: {
              _id: '23',
              name: 'Hand Sanitizer',
              brandName: 'Dettol',
              category: 'Personal Hygiene',
              description: 'Kills 99.9% germs without water',
              price: 149.99,
              genericAvailable: true,
              genericPrice: 99.99,
              requiresPrescription: false,
              dosage: '500ml',
              manufacturer: 'Reckitt Benckiser',
              sideEffects: ['Skin dryness', 'Allergic reactions'],
              usage: 'Apply small amount and rub hands until dry',
              warnings: ['Keep away from fire', 'For external use only']
            },
            quantity: 200,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '24',
              name: 'Antiseptic Liquid',
              brandName: 'Dettol',
              category: 'Personal Hygiene',
              description: 'Multi-purpose antiseptic liquid',
              price: 199.99,
              genericAvailable: true,
              genericPrice: 139.99,
              requiresPrescription: false,
              dosage: '250ml',
              manufacturer: 'Reckitt Benckiser',
              sideEffects: ['Skin irritation if undiluted'],
              usage: 'Dilute as per instructions before use',
              warnings: ['Do not use undiluted', 'Keep away from children']
            },
            quantity: 80,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Diabetes Care
          {
            medicine: {
              _id: '25',
              name: 'Metformin',
              brandName: 'Glucophage',
              category: 'Diabetes Care',
              description: 'Oral diabetes medicine to control blood sugar',
              price: 199.99,
              genericAvailable: true,
              genericPrice: 129.99,
              requiresPrescription: true,
              dosage: '500mg',
              manufacturer: 'Merck',
              sideEffects: ['Nausea', 'Diarrhea', 'Loss of appetite'],
              usage: 'Take as prescribed by your doctor',
              warnings: ['Regular blood sugar monitoring required', 'Avoid alcohol']
            },
            quantity: 0,
            status: 'OUT_OF_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '26',
              name: 'Glucometer',
              brandName: 'Accu-Chek',
              category: 'Diabetes Care',
              description: 'Blood glucose monitoring system',
              price: 1299.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: 'Device',
              manufacturer: 'Roche',
              sideEffects: [],
              usage: 'Follow user manual for testing',
              warnings: ['Use only specified test strips', 'Regular calibration needed']
            },
            quantity: 12,
            status: 'LOW_STOCK',
            pharmacy: null
          },

          // Heart Health
          {
            medicine: {
              _id: '27',
              name: 'Aspirin',
              brandName: 'Disprin',
              category: 'Heart Health',
              description: 'Blood-thinning medication for heart health',
              price: 79.99,
              genericAvailable: true,
              genericPrice: 39.99,
              requiresPrescription: false,
              dosage: '75mg',
              manufacturer: 'Bayer',
              sideEffects: ['Stomach upset', 'Increased bleeding risk'],
              usage: 'Take one tablet daily with food',
              warnings: ['Not for people with bleeding disorders', 'Avoid if allergic to NSAIDs']
            },
            quantity: 75,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Digestive Health
          {
            medicine: {
              _id: '28',
              name: 'Omeprazole',
              brandName: 'Prilosec',
              category: 'Digestive Health',
              description: 'Reduces stomach acid production',
              price: 129.99,
              genericAvailable: true,
              genericPrice: 79.99,
              requiresPrescription: false,
              dosage: '20mg',
              manufacturer: 'AstraZeneca',
              sideEffects: ['Headache', 'Stomach pain', 'Nausea'],
              usage: 'Take one capsule daily before breakfast',
              warnings: ['Complete prescribed course', 'Take on empty stomach']
            },
            quantity: 85,
            status: 'IN_STOCK',
            pharmacy: null
          },
          {
            medicine: {
              _id: '29',
              name: 'Probiotic Capsules',
              brandName: 'Enterogermina',
              category: 'Digestive Health',
              description: 'Restores intestinal bacterial flora',
              price: 199.99,
              genericAvailable: true,
              genericPrice: 139.99,
              requiresPrescription: false,
              dosage: '2 billion spores',
              manufacturer: 'Sanofi',
              sideEffects: ['Mild bloating', 'Gas'],
              usage: 'Take 1-2 capsules daily on empty stomach',
              warnings: ['Store in refrigerator', 'Complete the course']
            },
            quantity: 40,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Hair Care
          {
            medicine: {
              _id: '30',
              name: 'Anti-Dandruff Shampoo',
              brandName: 'Head & Shoulders',
              category: 'Hair Care',
              description: 'Controls dandruff and soothes scalp',
              price: 299.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '400ml',
              manufacturer: 'Procter & Gamble',
              sideEffects: ['Rare scalp irritation'],
              usage: 'Use 2-3 times per week',
              warnings: ['Avoid contact with eyes', 'For external use only']
            },
            quantity: 55,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Protein & Fitness
          {
            medicine: {
              _id: '31',
              name: 'Whey Protein',
              brandName: 'Optimum Nutrition',
              category: 'Protein & Fitness',
              description: 'High-quality protein supplement for muscle building',
              price: 3999.99,
              genericAvailable: false,
              genericPrice: null,
              requiresPrescription: false,
              dosage: '2.27kg',
              manufacturer: 'Optimum Nutrition',
              sideEffects: ['Bloating', 'Digestive issues in lactose intolerant'],
              usage: 'Mix 1 scoop with 150ml water or milk',
              warnings: ['Consult trainer for dosage', 'Not a substitute for balanced diet']
            },
            quantity: 25,
            status: 'IN_STOCK',
            pharmacy: null
          },

          // Men's Health
          {
            medicine: {
              _id: '32',
              name: 'Hair Growth Serum',
              brandName: 'Minoxidil',
              category: 'Men\'s Health',
              description: 'Topical solution for hair regrowth',
              price: 899.99,
              genericAvailable: true,
              genericPrice: 599.99,
              requiresPrescription: true,
              dosage: '60ml',
              manufacturer: 'Johnson & Johnson',
              sideEffects: ['Scalp irritation', 'Unwanted hair growth'],
              usage: 'Apply 1ml twice daily to affected area',
              warnings: ['For external use only', 'Results visible after 3-6 months']
            },
            quantity: 18,
            status: 'LOW_STOCK',
            pharmacy: null
          }
        ];
        this.currentSort = null;
        this.init();
      }

      async init() {
        try {
          showLoading();
          await this.getUserLocation();
          await this.assignNearbyPharmacies();
          await this.loadMedicinesWithInventory();
          this.setupSearch();
          this.updateStatistics();
          this.updateNearbyPharmaciesDisplay();
          hideLoading();
        } catch (error) {
          console.error('Error initializing medicine display:', error);
          this.handleError(error);
        }
      }

      setupSearch() {
        const searchInput = document.querySelector('input[type="text"]');
        const sortDropdown = document.getElementById('sortDropdown');
        const filterSidebar = document.getElementById('filterSidebar');
        if (!searchInput || !sortDropdown || !filterSidebar) return;

        searchInput.addEventListener('input', () => this.filterAndSortMedicines());
        const priceSlider = filterSidebar.querySelector('.price-slider');
        if (priceSlider) priceSlider.addEventListener('input', () => this.filterAndSortMedicines());
        const categoryCheckboxes = filterSidebar.querySelectorAll('input[data-category]');
        categoryCheckboxes.forEach(checkbox => checkbox.addEventListener('change', () => this.filterAndSortMedicines()));
        filterSidebar.querySelectorAll('input[value="inStockOnly"],input[value="noPrescriptionNeeded"]').forEach(checkbox => checkbox.addEventListener('change', () => this.filterAndSortMedicines()));
        sortDropdown.querySelectorAll('button[data-sort]').forEach(option => {
          option.addEventListener('click', (e) => {
            this.currentSort = e.target.getAttribute('data-sort');
            this.filterAndSortMedicines();
            sortDropdown.classList.add('hidden');
          });
        });
      }

      filterAndSortMedicines() {
        const searchTerm = document.querySelector('input[type="text"]').value.toLowerCase();
        const priceSlider = document.querySelector('.price-slider');
        const maxPrice = priceSlider ? parseFloat(priceSlider.value) : 1000;
        const selectedCategories = Array.from(document.querySelectorAll('input[data-category]:checked')).map(cb => cb.getAttribute('data-category'));
        const inStockOnly = document.querySelector('input[value="inStockOnly"]')?.checked;
        const noPrescriptionNeeded = document.querySelector('input[value="noPrescriptionNeeded"]')?.checked;

        let filteredData = this.mockData.filter(item => {
          const { medicine } = item;
          const matchesSearch = medicine.name.toLowerCase().includes(searchTerm) ||
            medicine.category.toLowerCase().includes(searchTerm) ||
            medicine.description.toLowerCase().includes(searchTerm);
          const matchesPrice = medicine.price <= maxPrice;
          const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(medicine.category);
          const matchesStock = !inStockOnly || item.status === 'IN_STOCK';
          const matchesPrescription = !noPrescriptionNeeded || !medicine.requiresPrescription;
          return matchesSearch && matchesPrice && matchesCategory && matchesStock && matchesPrescription;
        });

        if (this.currentSort) {
          filteredData.sort((a, b) => {
            switch (this.currentSort) {
              case 'price-low-high': return a.medicine.price - b.medicine.price;
              case 'price-high-low': return b.medicine.price - a.medicine.price;
              case 'popularity': return (b.quantity || 0) - (a.quantity || 0);
              case 'latest': return (parseFloat(a.pharmacy.distance) || 0) - (parseFloat(b.pharmacy.distance) || 0);
              default: return 0;
            }
          });
        }
        this.displayMedicinesWithInventory(filteredData);
        this.updateResultCount(filteredData.length);
      }

      updateResultCount(count) {
        const container = document.getElementById('medicineGrid');
        let existingCount = container.querySelector('.result-count');
        if (existingCount) existingCount.remove();
        const countElement = document.createElement('div');
        countElement.className = 'result-count col-span-full mb-4 text-gray-600';
        countElement.textContent = `${count} medicines found`;
        container.prepend(countElement);
      }

      async getUserLocation() {
        return new Promise((resolve, reject) => {
          if (!('geolocation' in navigator)) {
            console.warn('Geolocation not supported, using default location');
            // Default to central location between Dammaiguda and Nagaram
            this.currentLocation = { 
              lat: 17.4575, 
              lng: 78.5775,
              area: 'Dammaiguda-Nagaram Area'
            };
            resolve(this.currentLocation);
            return;
          }

          // Show location permission request message
          showToast('Requesting location permission for better service...', 'info');

          navigator.geolocation.getCurrentPosition(
            (position) => {
              this.currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              };
              
              // Determine if user is in Dammaiguda/Nagaram area
              const area = this.determineArea(this.currentLocation.lat, this.currentLocation.lng);
              this.currentLocation.area = area;
              
              console.log('Location obtained:', this.currentLocation);
              showToast(`Location detected: ${area}`, 'success');
              resolve(this.currentLocation);
            },
            (error) => {
              console.warn('Geolocation error:', error.message);
              // Fallback to default location in Dammaiguda-Nagaram area
              this.currentLocation = { 
                lat: 17.4575, 
                lng: 78.5775,
                area: 'Dammaiguda-Nagaram Area (Default)'
              };
              showToast('Using default location: Dammaiguda-Nagaram Area', 'info');
              resolve(this.currentLocation);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 300000 // 5 minutes
            }
          );
        });
      }

      determineArea(lat, lng) {
        // Define boundaries for Dammaiguda and Nagaram
        const dammaigudaBounds = {
          north: 17.4600,
          south: 17.4480,
          east: 78.5780,
          west: 78.5650
        };
        
        const nagaramBounds = {
          north: 17.4680,
          south: 17.4550,
          east: 78.5900,
          west: 78.5750
        };

        if (lat >= dammaigudaBounds.south && lat <= dammaigudaBounds.north &&
            lng >= dammaigudaBounds.west && lng <= dammaigudaBounds.east) {
          return 'Dammaiguda';
        } else if (lat >= nagaramBounds.south && lat <= nagaramBounds.north &&
                   lng >= nagaramBounds.west && lng <= nagaramBounds.east) {
          return 'Nagaram';
        } else {
          return 'Dammaiguda-Nagaram Area';
        }
      }

      calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Earth's radius in kilometers
        const dLat = this.degToRad(lat2 - lat1);
        const dLng = this.degToRad(lng2 - lng1);
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(this.degToRad(lat1)) * Math.cos(this.degToRad(lat2)) * 
          Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        return distance;
      }

      degToRad(deg) {
        return deg * (Math.PI/180);
      }

      async assignNearbyPharmacies() {
        if (!this.currentLocation) return;

        // Calculate distances to all medical shops
        const shopsWithDistance = this.realMedicalShops.map(shop => ({
          ...shop,
          distance: this.calculateDistance(
            this.currentLocation.lat,
            this.currentLocation.lng,
            shop.lat,
            shop.lng
          )
        }));

        // Sort by distance
        shopsWithDistance.sort((a, b) => a.distance - b.distance);

        // Assign nearest pharmacies to medicines
        this.mockData.forEach((item, index) => {
          const shopIndex = index % shopsWithDistance.length;
          const shop = shopsWithDistance[shopIndex];
          item.pharmacy = {
            name: shop.name,
            address: shop.address,
            distance: `${shop.distance.toFixed(1)} km`,
            rating: shop.rating,
            phone: shop.phone,
            type: shop.type,
            services: shop.services,
            established: shop.established,
            coordinates: { lat: shop.lat, lng: shop.lng }
          };
        });

        console.log('Assigned nearby pharmacies to medicines');
      }

      updateNearbyPharmaciesDisplay() {
        if (!this.currentLocation) return;

        // Get nearest 3 pharmacies for display
        const nearestShops = this.realMedicalShops
          .map(shop => ({
            ...shop,
            distance: this.calculateDistance(
              this.currentLocation.lat,
              this.currentLocation.lng,
              shop.lat,
              shop.lng
            )
          }))
          .sort((a, b) => a.distance - b.distance)
          .slice(0, 3);

        // Update the nearby pharmacies section
        const nearbyPharmaciesContainer = document.querySelector('.bg-gray-50.rounded-lg.p-4:last-child .space-y-2');
        if (nearbyPharmaciesContainer) {
          nearbyPharmaciesContainer.innerHTML = nearestShops.map(shop => `
            <div class="flex items-center justify-between text-sm cursor-pointer hover:bg-gray-100 p-2 rounded" 
                 onclick="medicineDisplay.showPharmacyDetails('${shop.name}')">
              <div>
                <span class="text-gray-800 font-medium">${shop.name}</span>
                <div class="text-xs text-gray-500">${shop.type}</div>
              </div>
              <div class="text-right">
                <span class="text-teal-600 font-medium">${shop.distance.toFixed(1)} km</span>
                <div class="flex items-center text-xs">
                  <i class="material-icons text-yellow-400 text-xs">star</i>
                  <span class="ml-1">${shop.rating}</span>
                </div>
              </div>
            </div>
          `).join('');
        }

        // Update delivery estimates based on current location
        this.updateDeliveryEstimates();
      }

      updateDeliveryEstimates() {
        const deliveryContainer = document.querySelector('.bg-gradient-to-r.from-teal-50.to-green-50');
        if (deliveryContainer) {
          // Calculate delivery times based on distance to nearest pharmacy
          const nearestDistance = Math.min(...this.realMedicalShops.map(shop => 
            this.calculateDistance(
              this.currentLocation.lat,
              this.currentLocation.lng,
              shop.lat,
              shop.lng
            )
          ));

          let expressTime, standardTime, currentLoad;
          
          if (nearestDistance <= 1) {
            expressTime = '10-15 mins';
            standardTime = '20-30 mins';
            currentLoad = 'Low';
          } else if (nearestDistance <= 2) {
            expressTime = '15-20 mins';
            standardTime = '30-45 mins';
            currentLoad = 'Medium';
          } else {
            expressTime = '20-30 mins';
            standardTime = '45-60 mins';
            currentLoad = 'High';
          }

          const deliveryGrid = deliveryContainer.querySelector('.grid.grid-cols-1.md\\:grid-cols-3.gap-4');
          if (deliveryGrid) {
            deliveryGrid.innerHTML = `
              <div class="flex items-center gap-3">
                <i class="material-icons text-teal-500">flash_on</i>
                <div>
                  <div class="font-medium text-gray-800">Express Delivery</div>
                  <div class="text-sm text-gray-600">${expressTime}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <i class="material-icons text-blue-500">local_shipping</i>
                <div>
                  <div class="font-medium text-gray-800">Standard Delivery</div>
                  <div class="text-sm text-gray-600">${standardTime}</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <i class="material-icons text-orange-500">schedule</i>
                <div>
                  <div class="font-medium text-gray-800">Current Load</div>
                  <div class="text-sm ${currentLoad === 'Low' ? 'text-green-600' : currentLoad === 'Medium' ? 'text-orange-600' : 'text-red-600'}">${currentLoad}</div>
                </div>
              </div>
            `;
          }
        }
      }

      showPharmacyDetails(pharmacyName) {
        const pharmacy = this.realMedicalShops.find(shop => shop.name === pharmacyName);
        if (!pharmacy) return;

        const distance = this.calculateDistance(
          this.currentLocation.lat,
          this.currentLocation.lng,
          pharmacy.lat,
          pharmacy.lng
        );

        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        popup.innerHTML = `
          <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-start mb-6">
                <div>
                  <h2 class="text-2xl font-semibold">${pharmacy.name}</h2>
                  <p class="text-gray-500">${pharmacy.type}</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="text-gray-400 hover:text-gray-600 transition-all">
                  <i class="material-icons">close</i>
                </button>
              </div>
              
              <div class="space-y-6">
                <div class="bg-gray-50 rounded-xl p-6">
                  <h3 class="font-medium text-gray-800 mb-4">Contact Information</h3>
                  <div class="space-y-3">
                    <div class="flex items-center gap-3">
                      <i class="material-icons text-gray-600">location_on</i>
                      <span class="text-gray-800">${pharmacy.address}</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <i class="material-icons text-gray-600">phone</i>
                      <a href="tel:${pharmacy.phone}" class="text-teal-600 hover:text-teal-700">${pharmacy.phone}</a>
                    </div>
                    <div class="flex items-center gap-3">
                      <i class="material-icons text-gray-600">directions</i>
                      <span class="text-gray-800">${distance.toFixed(1)} km away</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <i class="material-icons text-gray-600">star</i>
                      <span class="text-gray-800">${pharmacy.rating}/5 rating</span>
                    </div>
                    <div class="flex items-center gap-3">
                      <i class="material-icons text-gray-600">access_time</i>
                      <span class="text-gray-800">Established ${pharmacy.established}</span>
                    </div>
                  </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-6">
                  <h3 class="font-medium text-gray-800 mb-4">Services Available</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    ${pharmacy.services.map(service => `
                      <div class="flex items-center gap-2">
                        <i class="material-icons text-teal-500 text-sm">check_circle</i>
                        <span class="text-gray-800">${service}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>

                <div class="flex gap-4">
                  <button onclick="medicineDisplay.callPharmacy('${pharmacy.phone}')" 
                          class="flex-1 bg-teal-500 hover:bg-teal-600 text-white px-4 py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="material-icons">phone</i>
                    Call Pharmacy
                  </button>
                  <button onclick="medicineDisplay.getDirections(${pharmacy.lat}, ${pharmacy.lng})" 
                          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="material-icons">directions</i>
                    Get Directions
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(popup);
      }

      callPharmacy(phoneNumber) {
        window.location.href = `tel:${phoneNumber}`;
      }

      getDirections(lat, lng) {
        // Open Google Maps with directions
        const url = `https://www.google.com/maps/dir/${this.currentLocation.lat},${this.currentLocation.lng}/${lat},${lng}`;
        window.open(url, '_blank');
      }

      async loadMedicinesWithInventory() {
        this.displayMedicinesWithInventory(this.mockData);
        this.clearError();
      }

      displayMedicinesWithInventory(inventory) {
        const container = document.getElementById('medicineGrid');
        container.innerHTML = inventory.map(item => this.createMedicineCard(item)).join('');
        this.setupCardEventListeners();
      }

      createMedicineCard(item) {
        const { medicine, quantity, status, pharmacy } = item;
        const statusClass = this.getStatusClass(status);
        const statusText = this.getStatusText(status);
        
        // Calculate discount percentage
        const discountPercent = medicine.genericAvailable ? 
          Math.round(((medicine.price * 1.5 - medicine.price) / (medicine.price * 1.5)) * 100) : 0;
        
        // Generate rating (mock rating for demo)
        const rating = (Math.random() * 2 + 3).toFixed(1); // 3.0 to 5.0
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        
        // Availability indicator class
        const availabilityClass = status === 'OUT_OF_STOCK' ? 'out-of-stock' : 
                                 status === 'LOW_STOCK' ? 'low-stock' : '';
        
        const prescriptionBadge = medicine.requiresPrescription ? 
          '<div class="prescription-required"><i class="material-icons text-xs">description</i>Rx Required</div>' : '';
        
        const genericBadge = medicine.genericAvailable ?
          '<span class="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-medium">Generic Available</span>' : '';

        return `
          <div class="medicine-card bg-white rounded-2xl shadow-md overflow-hidden relative cursor-pointer transform transition-all duration-300">
            <!-- Availability Indicator -->
            <div class="availability-indicator ${availabilityClass}"></div>
            
            <!-- Discount Badge -->
            ${discountPercent > 0 ? 
              `<div class="discount-badge">
                ${discountPercent}% OFF
              </div>` : ''}
            
            <!-- Price Badge -->
            <div class="price-badge">â‚¹${medicine.price}</div>
            
            <!-- Medicine Icon Section -->
            <div class="h-48 bg-gradient-to-br from-teal-50 to-green-50 flex items-center justify-center relative overflow-hidden">
              <i class="medicine-icon fas fa-pills text-6xl text-teal-500 transform transition-all duration-300"></i>
              ${status === 'LOW_STOCK' ? 
                `<div class="absolute bottom-3 left-3 bg-yellow-500 text-white text-xs px-3 py-1 rounded-full font-medium animate-pulse">
                  Only ${quantity} left!
                </div>` : ''}
              
              <!-- Quick View Button -->
              <button class="quick-view-btn" onclick="medicineDisplay.showMedicineDetails(this.closest('.medicine-card')); event.stopPropagation();">
                <i class="material-icons">visibility</i>
              </button>
            </div>

            <!-- Medicine Information Section -->
            <div class="p-6">
              <!-- Header Section -->
              <div class="mb-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-900 mb-1 leading-tight">${medicine.name}</h3>
                    <p class="text-sm text-gray-600 font-medium">${medicine.brandName} â€¢ ${medicine.manufacturer}</p>
                  </div>
                  <div class="ml-4 text-right">
                    <span class="${statusClass}">${statusText}</span>
                  </div>
                </div>
                
                <!-- Rating and Category Row -->
                <div class="flex items-center justify-between mb-3">
                  <div class="rating-stars">
                    ${Array(fullStars).fill('<i class="material-icons star">star</i>').join('')}
                    ${hasHalfStar ? '<i class="material-icons star">star_half</i>' : ''}
                    ${Array(emptyStars).fill('<i class="material-icons star empty">star</i>').join('')}
                    <span class="text-sm text-gray-600 ml-2">${rating} (${Math.floor(Math.random() * 200 + 50)} reviews)</span>
                  </div>
                  <div class="flex items-center text-sm text-gray-600">
                    <i class="material-icons text-sm mr-1 text-gray-500">category</i>
                    <span class="font-medium">${medicine.category}</span>
                  </div>
                </div>

                <!-- Badges Row -->
                <div class="flex flex-wrap gap-2 mb-3">
                  ${prescriptionBadge}
                  ${genericBadge}
                </div>
              </div>

              <!-- Description -->
              <div class="mb-4">
                <p class="text-sm text-gray-700 leading-relaxed line-clamp-2">${medicine.description}</p>
              </div>

              <!-- Price and Pharmacy Section -->
              <div class="mb-4 pb-4 border-b border-gray-100">
                <div class="flex justify-between items-end">
                  <!-- Price Section -->
                  <div class="flex-1">
                    <div class="flex items-baseline gap-2 mb-1">
                      <span class="text-2xl font-bold text-teal-600">â‚¹${medicine.price}</span>
                      ${medicine.genericAvailable ? 
                        `<span class="text-sm text-gray-500 line-through">â‚¹${(medicine.price * 1.5).toFixed(2)}</span>` : ''}
                    </div>
                    ${medicine.genericAvailable ? 
                      `<p class="text-xs text-blue-600 font-medium">Generic from â‚¹${medicine.genericPrice}</p>` : ''}
                  </div>
                  
                  <!-- Quantity Controls -->
                  <div class="flex items-center gap-2 ml-4">
                    ${this.getQuantityControls(item)}
                  </div>
                </div>
              </div>

              <!-- Pharmacy Information -->
              <div class="mb-4">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center text-gray-600">
                    <i class="material-icons text-sm mr-2 text-gray-500">store</i>
                    <span class="font-medium">${pharmacy.name}</span>
                  </div>
                  <div class="flex items-center text-gray-600">
                    <i class="material-icons text-yellow-400 text-sm mr-1">star</i>
                    <span class="font-medium">${pharmacy.rating}</span>
                  </div>
                </div>
                <div class="mt-1 ml-6">
                  <p class="text-xs text-gray-500">${pharmacy.type}</p>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex justify-between items-center">
                <button onclick="medicineDisplay.showMedicineDetails(this.closest('.medicine-card'))"
                        class="text-teal-600 hover:text-teal-700 text-sm font-medium flex items-center gap-1 transition-all duration-200 hover:bg-teal-50 px-3 py-2 rounded-lg">
                  <i class="material-icons text-sm">info</i>
                  <span>View Details</span>
                </button>
                
                ${status !== 'OUT_OF_STOCK' ? 
                  `<div class="flex items-center gap-3 text-xs text-gray-500">
                    <div class="flex items-center">
                      <i class="material-icons text-sm mr-1 text-green-500">verified</i>
                      <span class="font-medium">Genuine</span>
                    </div>
                    <div class="flex items-center">
                      <i class="material-icons text-sm mr-1 text-blue-500">security</i>
                      <span class="font-medium">Safe</span>
                    </div>
                  </div>` : 
                  `<div class="text-xs text-red-500 font-medium">
                    <i class="material-icons text-sm mr-1">info</i>
                    Currently unavailable
                  </div>`}
              </div>
            </div>
          </div>
        `;
      }

      getStatusClass(status) {
        switch (status) {
          case 'IN_STOCK':
            return 'bg-teal-100 text-teal-600 text-xs px-2 py-1 rounded-full';
          case 'LOW_STOCK':
            return 'bg-yellow-100 text-yellow-600 text-xs px-2 py-1 rounded-full';
          case 'OUT_OF_STOCK':
            return 'bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full';
          default:
            return 'bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full';
        }
      }

      getStatusText(status) {
        switch (status) {
          case 'IN_STOCK':
            return 'In Stock';
          case 'LOW_STOCK':
            return 'Low Stock';
          case 'OUT_OF_STOCK':
            return 'Out of Stock';
          default:
            return 'Unknown';
        }
      }

      getQuantityControls(item) {
        if (item.status === 'OUT_OF_STOCK') {
          return `
            <button onclick="medicineDisplay.findAlternatives('${item.medicine._id}')" 
                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 text-sm font-medium shadow-sm">
              <i class="material-icons text-sm">swap_horiz</i>
              <span>Find Alternatives</span>
            </button>
          `;
        }

        return `
          <div class="flex items-center bg-gray-100 rounded-lg border border-gray-200">
            <button class="minus-btn px-3 py-2 text-gray-600 hover:text-teal-600 hover:bg-gray-50 transition-all duration-200 rounded-l-lg">
              <i class="material-icons text-sm">remove</i>
            </button>
            <span class="w-12 text-center py-2 bg-white font-medium text-gray-800 border-x border-gray-200">1</span>
            <button class="plus-btn px-3 py-2 text-gray-600 hover:text-teal-600 hover:bg-gray-50 transition-all duration-200 rounded-r-lg">
              <i class="material-icons text-sm">add</i>
            </button>
          </div>
          <button type="button" class="add-to-cart-btn bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 text-sm font-medium shadow-sm ml-2">
            <i class="material-icons text-sm">add_shopping_cart</i>
            <span>Add</span>
          </button>
        `;
      }

      async findAlternatives(medicineId) {
        try {
          const response = await fetch(
            `/api/inventory/alternatives/${medicineId}?lat=${this.currentLocation.lat}&lng=${this.currentLocation.lng}`
          );
          
          if (!response.ok) {
            throw new Error('Failed to fetch alternatives');
          }

          const alternatives = await response.json();
          this.showAlternativesPopup(alternatives);
        } catch (error) {
          console.error('Error finding alternatives:', error);
          showToast('Error finding alternative medicines', 'error');
        }
      }

      showAlternativesPopup(alternatives) {
        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        popup.innerHTML = `
          <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-start mb-6">
                <h2 class="text-2xl font-semibold">Alternative Medicines</h2>
                <button onclick="this.closest('.fixed').remove()" 
                        class="text-gray-400 hover:text-gray-600 transition-all">
                  <i class="material-icons">close</i>
                </button>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${alternatives.map(alt => this.createAlternativeCard(alt)).join('')}
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(popup);
      }

      createAlternativeCard(alternative) {
        return `
          <div class="bg-white rounded-xl border p-4 hover:border-teal-500 transition-all duration-300">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-medium">${alternative.medicine.name}</h3>
              <span class="bg-teal-100 text-teal-600 text-xs px-2 py-1 rounded-full">In Stock</span>
            </div>
            <p class="text-sm text-gray-600 mb-2">${alternative.medicine.description}</p>
            <div class="flex justify-between items-center">
              <span class="font-bold text-teal-600">â‚¹${alternative.medicine.price}</span>
              <button onclick="medicineDisplay.addToCart(${JSON.stringify(alternative)})" 
                      class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded-lg text-sm">
                Add to Cart
              </button>
            </div>
          </div>
        `;
      }

      setupCardEventListeners() {
        document.querySelectorAll('.medicine-card').forEach(card => {
          // Quantity controls
          const minusBtn = card.querySelector('.minus-btn');
          const plusBtn = card.querySelector('.plus-btn');
          if (minusBtn && plusBtn) {
            minusBtn.addEventListener('click', (e) => { e.stopPropagation(); this.updateQuantity(minusBtn, -1); });
            plusBtn.addEventListener('click', (e) => { e.stopPropagation(); this.updateQuantity(plusBtn, 1); });
          }
          // Add to cart
          const addToCartBtn = card.querySelector('.add-to-cart-btn');
          if (addToCartBtn) {
            addToCartBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const name = card.querySelector('h3').textContent;
              const item = this.mockData.find(item => item.medicine.name === name);
              const quantity = parseInt(card.querySelector('.flex.items-center.bg-gray-100 span').textContent);
              this.addToCart(item.medicine, quantity);
            });
          }
          // Details
          card.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', (e) => { e.stopPropagation(); this.showMedicineDetails(card); });
          });
          // Card click for details
          card.addEventListener('click', () => this.showMedicineDetails(card));
        });
      }

      updateQuantity(btn, change) {
        const span = btn.parentElement.querySelector('span');
        let qty = parseInt(span.textContent) || 1;
        qty = Math.max(1, qty + change);
        span.textContent = qty;
      }

      addToCart(medicine, quantity) {
        const isPrescriptionRequired = medicine.requiresPrescription;
        const addItemToCart = () => {
          const existingItemIndex = cartItems.findIndex(item => item.name === medicine.name);
          if (existingItemIndex !== -1) {
            cartItems[existingItemIndex].quantity = (cartItems[existingItemIndex].quantity || 1) + quantity;
            showToast(`Added ${quantity} more ${medicine.name} (${cartItems[existingItemIndex].quantity} total)`);
          } else {
            cartItems.push({ 
              name: medicine.name, 
              price: `â‚¹${medicine.price}`, 
              priceValue: medicine.price, 
              quantity: quantity,
              id: medicine._id || Math.random().toString(36).substr(2, 9),
              category: medicine.category,
              brandName: medicine.brandName
            });
            showToast(`Added ${quantity} ${medicine.name} to cart!`);
          }
          localStorage.setItem('cartItems', JSON.stringify(cartItems));
          updateCartBadge();
          console.log('Item added to cart:', medicine.name, 'Quantity:', quantity); // Debug log
        };
        if (isPrescriptionRequired) {
          showPrescriptionPopup(medicine.name, addItemToCart);
        } else {
          addItemToCart();
        }
      }

      showMedicineDetails(medicineCard) {
        const item = this.mockData.find(item => 
          item.medicine.name === medicineCard.querySelector('h3').textContent
        );
        if (!item) return;
        const { medicine, quantity, status, pharmacy } = item;
        const popup = document.createElement('div');
        popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        popup.innerHTML = `
          <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <!-- Header Section -->
              <div class="flex justify-between items-start mb-6 pb-4 border-b border-gray-100">
                <div class="flex-1">
                  <h2 class="text-3xl font-bold text-gray-900 mb-2">${medicine.name}</h2>
                  <div class="flex items-center gap-4 text-gray-600">
                    <span class="text-lg font-medium">${medicine.brandName}</span>
                    <span class="text-sm px-3 py-1 bg-gray-100 rounded-full">${medicine.category}</span>
                    <span class="text-sm px-3 py-1 bg-teal-100 text-teal-700 rounded-full">${medicine.dosage}</span>
                  </div>
                </div>
                <button onclick="this.closest('.fixed').remove()" 
                        class="text-gray-400 hover:text-gray-600 transition-all p-2 hover:bg-gray-100 rounded-lg">
                  <i class="material-icons">close</i>
                </button>
              </div>
              
              <div class="grid md:grid-cols-2 gap-8">
                <!-- Left Column -->
                <div class="space-y-6">
                  <!-- Medicine Visual -->
                  <div class="bg-gradient-to-br from-teal-50 to-green-50 rounded-xl p-12 flex items-center justify-center border border-teal-100">
                    <i class="fas fa-pills text-9xl text-teal-500"></i>
                  </div>

                  <!-- Pharmacy Information -->
                  <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 border border-gray-200">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <i class="material-icons text-teal-500">store</i>
                      Pharmacy Information
                    </h3>
                    <div class="space-y-4">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Pharmacy Name</span>
                          <p class="text-gray-900 font-semibold">${pharmacy.name}</p>
                        </div>
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Type</span>
                          <p class="text-gray-900 font-semibold">${pharmacy.type}</p>
                        </div>
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Distance</span>
                          <p class="text-gray-900 font-semibold">${pharmacy.distance}</p>
                        </div>
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Rating</span>
                          <div class="flex items-center">
                            <i class="material-icons text-yellow-400 text-lg mr-1">star</i>
                            <span class="text-gray-900 font-semibold">${pharmacy.rating}/5</span>
                          </div>
                        </div>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Address</span>
                        <p class="text-gray-900 font-semibold mt-1">${pharmacy.address}</p>
                      </div>
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Established</span>
                        <p class="text-gray-900 font-semibold">${pharmacy.established}</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-6">
                  <!-- Medicine Details -->
                  <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <i class="material-icons text-blue-500">medical_services</i>
                      Medicine Details
                    </h3>
                    <div class="space-y-4">
                      <div>
                        <span class="text-sm text-gray-600 font-medium">Description</span>
                        <p class="text-gray-900 mt-1 leading-relaxed">${medicine.description}</p>
                      </div>
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Manufacturer</span>
                          <p class="text-gray-900 font-semibold">${medicine.manufacturer}</p>
                        </div>
                        <div>
                          <span class="text-sm text-gray-600 font-medium">Dosage</span>
                          <p class="text-gray-900 font-semibold">${medicine.dosage}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Usage & Safety Information -->
                  <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-6 border border-amber-100">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <i class="material-icons text-amber-500">health_and_safety</i>
                      Usage & Safety
                    </h3>
                    <div class="space-y-4">
                      <div>
                        <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                          <i class="material-icons text-xs">info</i>Usage Instructions
                        </h4>
                        <p class="text-gray-900 leading-relaxed bg-white p-3 rounded-lg">${medicine.usage}</p>
                      </div>
                      <div>
                        <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                          <i class="material-icons text-xs">warning</i>Side Effects
                        </h4>
                        <ul class="bg-white p-3 rounded-lg space-y-1">
                          ${medicine.sideEffects.map(effect => 
                            `<li class="text-gray-900 flex items-center gap-2">
                              <i class="material-icons text-xs text-orange-500">fiber_manual_record</i>
                              ${effect}
                            </li>`
                          ).join('')}
                        </ul>
                      </div>
                      <div>
                        <h4 class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-1">
                          <i class="material-icons text-xs">priority_high</i>Important Warnings
                        </h4>
                        <ul class="bg-white p-3 rounded-lg space-y-1">
                          ${medicine.warnings.map(warning => 
                            `<li class="text-gray-900 flex items-center gap-2">
                              <i class="material-icons text-xs text-red-500">fiber_manual_record</i>
                              ${warning}
                            </li>`
                          ).join('')}
                        </ul>
                      </div>
                    </div>
                  </div>

                  <!-- Purchase Section -->
                  <div class="bg-gradient-to-br from-teal-50 to-green-50 rounded-xl p-6 border-2 border-teal-200">
                    <div class="flex items-end justify-between mb-6">
                      <div class="flex-1">
                        <h3 class="font-bold text-gray-900 mb-2 flex items-center gap-2">
                          <i class="material-icons text-teal-500">local_offer</i>
                          Pricing
                        </h3>
                        <div class="flex items-baseline gap-3 mb-2">
                          <span class="text-4xl font-bold text-teal-600">â‚¹${medicine.price}</span>
                          ${medicine.genericAvailable ? 
                            `<span class="text-lg text-gray-500 line-through">â‚¹${(medicine.price * 1.5).toFixed(2)}</span>` : ''}
                        </div>
                        ${medicine.genericAvailable ? 
                          `<p class="text-sm text-blue-600 font-semibold bg-blue-100 px-3 py-1 rounded-full inline-block">
                            Generic available from â‚¹${medicine.genericPrice}
                          </p>` : ''}
                      </div>
                      
                      <div class="flex items-center gap-4 ml-6">
                        <div class="flex items-center bg-white rounded-lg border-2 border-gray-200 shadow-sm">
                          <button class="popup-minus-btn px-4 py-3 text-gray-600 hover:text-teal-600 hover:bg-teal-50 transition-all rounded-l-lg">
                            <i class="material-icons">remove</i>
                          </button>
                          <span class="w-16 text-center py-3 font-bold text-gray-900 bg-gray-50 border-x-2 border-gray-200">1</span>
                          <button class="popup-plus-btn px-4 py-3 text-gray-600 hover:text-teal-600 hover:bg-teal-50 transition-all rounded-r-lg">
                            <i class="material-icons">add</i>
                          </button>
                        </div>
                        <button class="popup-add-to-cart bg-teal-500 hover:bg-teal-600 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center gap-2 font-semibold shadow-lg">
                          <i class="material-icons">add_shopping_cart</i>
                          Add to Cart
                        </button>
                      </div>
                    </div>
                    
                    <!-- Trust Indicators -->
                    <div class="flex items-center justify-between pt-4 border-t border-teal-200">
                      <div class="flex items-center gap-6 text-sm">
                        <div class="flex items-center gap-2">
                          <i class="material-icons text-green-500">verified</i>
                          <span class="text-gray-700 font-medium">Genuine Product</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <i class="material-icons text-blue-500">security</i>
                          <span class="text-gray-700 font-medium">Safe Delivery</span>
                        </div>
                        ${medicine.requiresPrescription ? `
                          <div class="flex items-center gap-2 text-amber-600">
                            <i class="material-icons">description</i>
                            <span class="font-medium">Prescription Required</span>
                          </div>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        // Attach popup quantity controls and add to cart
        setTimeout(() => {
          const minusBtn = popup.querySelector('.popup-minus-btn');
          const plusBtn = popup.querySelector('.popup-plus-btn');
          const qtySpan = popup.querySelector('.w-16.text-center');
          let qty = 1;
          minusBtn.addEventListener('click', (e) => { e.stopPropagation(); qty = Math.max(1, qty - 1); qtySpan.textContent = qty; });
          plusBtn.addEventListener('click', (e) => { e.stopPropagation(); qty = qty + 1; qtySpan.textContent = qty; });
          popup.querySelector('.popup-add-to-cart').addEventListener('click', (e) => {
            e.stopPropagation();
            this.addToCart(medicine, qty);
            popup.remove();
          });
        }, 0);
        document.body.appendChild(popup);
      }

      clearError() {
        const errorMessage = document.querySelector('.error-message');
        if (errorMessage) errorMessage.remove();
      }

      handleError(error) {
        showError('Unable to load medicines. Please try again later.');
      }

      getSimilarMedicines(medicine) {
        return this.mockData
          .filter(item => 
            item.medicine.category === medicine.category && 
            item.medicine._id !== medicine._id
          )
          .map(item => item.medicine)
          .slice(0, 3);
      }

      updateStatistics() {
        const totalMedicines = this.mockData.length;
        const inStock = this.mockData.filter(item => item.status === 'IN_STOCK').length;
        const lowStock = this.mockData.filter(item => item.status === 'LOW_STOCK').length;
        const outOfStock = this.mockData.filter(item => item.status === 'OUT_OF_STOCK').length;
        const highStock = this.mockData.filter(item => item.quantity > 50).length;
        const mediumStock = this.mockData.filter(item => item.quantity > 20 && item.quantity <= 50).length;

        // Update DOM elements
        document.getElementById('totalMedicines').textContent = totalMedicines;
        document.getElementById('lowStockItems').textContent = lowStock;
        document.getElementById('outOfStock').textContent = outOfStock;
        document.getElementById('highStock').textContent = highStock;
        document.getElementById('mediumStock').textContent = mediumStock;
        document.getElementById('lowStock').textContent = lowStock;

        // Update the static inventory display as well
        const inventoryHighStock = document.getElementById('highStock');
        const inventoryMediumStock = document.getElementById('mediumStock');
        const inventoryLowStock = document.getElementById('lowStock');
        
        if (inventoryHighStock) inventoryHighStock.textContent = highStock;
        if (inventoryMediumStock) inventoryMediumStock.textContent = mediumStock;
        if (inventoryLowStock) inventoryLowStock.textContent = lowStock;

        console.log(`Statistics updated: Total: ${totalMedicines}, In Stock: ${inStock}, Low Stock: ${lowStock}, Out of Stock: ${outOfStock}`);
      }

      async retryLoad() {
        try {
          this.retryAttempts++;
          if (this.retryAttempts <= this.maxRetries) {
            showToast(`Retrying... (${this.retryAttempts}/${this.maxRetries})`, 'info');
            await this.init();
          } else {
            showToast('Maximum retry attempts reached. Please refresh the page.', 'error');
          }
        } catch (error) {
          console.error('Retry failed:', error);
          showToast('Retry failed. Please check your internet connection.', 'error');
        }
      }
    }

    // Initialize the medicine display
    const medicineDisplay = new MedicineDisplay();

    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('medicineGrid').classList.add('hidden');
      
      // Animate loading progress
      const progressBar = document.getElementById('loadingProgress');
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        progressBar.style.width = progress + '%';
        if (progress >= 100) {
          clearInterval(interval);
        }
      }, 200);
    }

    function hideLoading() {
      // Complete the progress bar first
      const progressBar = document.getElementById('loadingProgress');
      progressBar.style.width = '100%';
      
      setTimeout(() => {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('medicineGrid').classList.remove('hidden');
      }, 500);
    }

    function showError(message) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('medicineGrid').classList.add('hidden');
      document.getElementById('errorMessage').textContent = message;
    }

    function retryLoading() {
      showLoading();
      // Add your retry logic here
      medicineDisplay.retryLoad();
    }

    // Missing utility functions
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500';
      const icon = type === 'error' ? 'error' : type === 'info' ? 'info' : 'check_circle';
      
      toast.className = `toast fixed top-4 right-4 z-50 px-6 py-4 rounded-lg text-white shadow-xl transform transition-all duration-300 ${bgColor}`;
      toast.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="material-icons">${icon}</i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(toast);
      
      // Animate in
      setTimeout(() => toast.style.transform = 'translateX(0)', 10);
      
      // Animate out and remove
      setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, type === 'info' ? 2000 : 3000);
    }

    function showPrescriptionPopup(medicineName, callback) {
      const popup = document.createElement('div');
      popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      popup.innerHTML = `
        <div class="bg-white rounded-xl max-w-md w-full p-6">
          <div class="text-center mb-6">
            <i class="material-icons text-yellow-500 text-6xl mb-4">description</i>
            <h2 class="text-xl font-semibold mb-2">Prescription Required</h2>
            <p class="text-gray-600">${medicineName} requires a valid prescription. Please upload your prescription to proceed.</p>
          </div>
          
          <div class="space-y-4">
            <button onclick="uploadPrescription('${medicineName}', ${callback})" 
                    class="w-full bg-teal-500 hover:bg-teal-600 text-white px-4 py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2">
              <i class="material-icons">upload</i>
              Upload Prescription
            </button>
            <button onclick="this.closest('.fixed').remove()" 
                    class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-3 rounded-lg transition-all duration-300">
              Cancel
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
    }

    function uploadPrescription(medicineName, callback) {
      // Simulate prescription upload
      showToast('Prescription uploaded successfully!');
      document.querySelector('.fixed').remove();
      callback();
    }

    function toggleSort() {
      const dropdown = document.getElementById('sortDropdown');
      dropdown.classList.toggle('hidden');
    }

    function toggleFilters() {
      const sidebar = document.getElementById('filterSidebar');
      sidebar.classList.toggle('hidden');
    }

    function clearFilters() {
      // Reset all checkboxes
      document.querySelectorAll('#filterSidebar input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });

      // Reset price slider
      const priceSlider = document.querySelector('.price-slider');
      if (priceSlider) {
        priceSlider.value = priceSlider.max;
        document.getElementById('priceValue').textContent = `â‚¹${priceSlider.value}`;
      }

      // Reset search input
      const searchInput = document.querySelector('input[type="text"]');
      if (searchInput) {
        searchInput.value = '';
      }

      // Reset sort dropdown
      const sortDropdown = document.getElementById('sortDropdown');
      if (sortDropdown) {
        sortDropdown.classList.add('hidden');
      }

      // Refresh the medicine display
      medicineDisplay.filterAndSortMedicines();
      
      // Show success message
      showToast('Filters cleared successfully');
    }

    // Initialize badges and cart state when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize cart badge
      updateCartBadge();
      
      // Initialize wishlist and compare badges
      updateWishlistBadge();
      updateCompareBadge();
      
      // Debug: Log current cart state
      console.log('Page loaded - Cart items:', cartItems.length, 'items:', cartItems);
      
      // Update price slider display
      const priceSlider = document.querySelector('.price-slider');
      if (priceSlider) {
        priceSlider.addEventListener('input', (e) => {
          document.getElementById('priceValue').textContent = `â‚¹${e.target.value}`;
        });
      }
    });

    function goToCart() {
      if (cartItems.length === 0) {
        showToast('Your cart is empty. Add some medicines first!', 'error');
        return;
      }
      // Navigate to cart page
      window.location.href = 'cart.html';
    }

    // Voice Assistant Implementation
    class MedicalVoiceAssistant {
      constructor() {
        this.isListening = false;
        this.recognition = null;
        this.synthesis = window.speechSynthesis;
        this.currentResponse = '';
        this.conversationHistory = [];
        this.medicalKnowledgeBase = this.initializeExpandedMedicalKB();
        this.initializeSpeechRecognition();
        this.initializeVoices();
      }

      initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          
          // Enhanced recognition settings
          this.recognition.continuous = false;
          this.recognition.interimResults = true;
          this.recognition.lang = 'en-US';
          this.recognition.maxAlternatives = 3;

          this.recognition.onstart = () => {
            this.isListening = true;
            this.updateListeningUI(true);
            console.log('Voice assistant started listening');
          };

          this.recognition.onresult = (event) => {
            let transcript = '';
            let confidence = 0;
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i][0]) {
                transcript += event.results[i][0].transcript;
                confidence = Math.max(confidence, event.results[i][0].confidence || 0.5);
              }
            }
            
            this.updateTranscription(transcript);
            
            if (event.results[event.results.length - 1].isFinal) {
              console.log('Final transcript:', transcript, 'Confidence:', confidence);
              this.processQuery(transcript, confidence);
            }
          };

          this.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            this.handleSpeechError(event.error);
          };

          this.recognition.onend = () => {
            this.isListening = false;
            this.updateListeningUI(false);
            console.log('Voice assistant stopped listening');
          };
        } else {
          console.warn('Speech recognition not supported');
          this.showUnsupportedMessage();
        }
      }

      initializeVoices() {
        // Wait for voices to be loaded
        if (this.synthesis.getVoices().length === 0) {
          this.synthesis.addEventListener('voiceschanged', () => {
            this.selectBestVoice();
          });
        } else {
          this.selectBestVoice();
        }
      }

      selectBestVoice() {
        const voices = this.synthesis.getVoices();
        // Prefer high-quality English voices
        this.preferredVoice = voices.find(voice => 
          (voice.name.includes('Google') || voice.name.includes('Microsoft') || voice.name.includes('Samantha')) &&
          voice.lang.startsWith('en')
        ) || voices.find(voice => voice.lang.startsWith('en'));
        
        console.log('Selected voice:', this.preferredVoice?.name || 'Default');
      }

      initializeExpandedMedicalKB() {
        return {
          // Pain Relief & Fever
          'paracetamol': {
            uses: 'Pain relief, fever reduction, headaches, muscle aches, dental pain, menstrual pain',
            dosage: 'Adults: 500-1000mg every 4-6 hours, maximum 4g daily. Children: 10-15mg/kg every 4-6 hours',
            sideEffects: 'Rare: liver damage with overdose, skin rash, nausea, allergic reactions',
            warnings: 'Do not exceed recommended dose. Avoid alcohol. Consult doctor if symptoms persist beyond 3 days',
            interactions: 'Avoid with other paracetamol-containing medicines. Be cautious with blood thinners',
            category: 'Pain Relief',
            alternatives: ['ibuprofen', 'aspirin'],
            prescriptionRequired: false
          },
          'ibuprofen': {
            uses: 'Pain relief, inflammation reduction, fever reduction, arthritis, sprains, menstrual cramps',
            dosage: 'Adults: 200-400mg every 4-6 hours, maximum 1.2g daily. Take with food',
            sideEffects: 'Stomach upset, heartburn, dizziness, increased bleeding risk, kidney problems',
            warnings: 'Take with food. Not suitable for stomach ulcer patients. Avoid if allergic to aspirin',
            interactions: 'Avoid with blood thinners, steroids, other NSAIDs. May interact with blood pressure medications',
            category: 'Anti-inflammatory',
            alternatives: ['paracetamol', 'aspirin'],
            prescriptionRequired: false
          },
          'aspirin': {
            uses: 'Pain relief, fever reduction, heart attack prevention, blood thinning, stroke prevention',
            dosage: 'Pain relief: 300-900mg every 4-6 hours. Heart protection: 75-100mg daily',
            sideEffects: 'Stomach irritation, increased bleeding risk, tinnitus, allergic reactions',
            warnings: 'Not for children under 16. Take with food. Monitor for bleeding. Avoid before surgery',
            interactions: 'Increases effect of blood thinners. May interact with diabetes medications',
            category: 'Heart Health',
            alternatives: ['paracetamol', 'ibuprofen'],
            prescriptionRequired: false
          },

          // Allergy & Cold
          'cetirizine': {
            uses: 'Allergy relief, hay fever, urticaria, itching, sneezing, runny nose, watery eyes',
            dosage: 'Adults: 10mg once daily. Children 6-12: 5mg once daily. Children 2-6: 2.5mg twice daily',
            sideEffects: 'Drowsiness, dry mouth, fatigue, headache, nausea',
            warnings: 'May cause drowsiness. Avoid alcohol. Reduce dose in kidney problems',
            interactions: 'Increases sedation with alcohol, sleeping pills, tranquilizers',
            category: 'Allergy Relief',
            alternatives: ['loratadine', 'fexofenadine'],
            prescriptionRequired: false
          },
          'loratadine': {
            uses: 'Non-drowsy allergy relief, hay fever, chronic urticaria',
            dosage: 'Adults and children over 12: 10mg once daily. Children 2-12: 5mg once daily',
            sideEffects: 'Headache, drowsiness (mild), dry mouth, fatigue',
            warnings: 'Less sedating than older antihistamines. Safe for most people',
            interactions: 'Minimal drug interactions. Safe with most medications',
            category: 'Allergy Relief',
            alternatives: ['cetirizine', 'fexofenadine'],
            prescriptionRequired: false
          },

          // Digestive Health
          'omeprazole': {
            uses: 'Acid reflux, stomach ulcers, heartburn, GERD, peptic ulcers, Zollinger-Ellison syndrome',
            dosage: 'Adults: 20-40mg once daily, preferably morning before food. Treatment duration: 4-8 weeks',
            sideEffects: 'Headache, stomach pain, nausea, diarrhea, constipation, flatulence',
            warnings: 'Take on empty stomach. Complete prescribed course. May affect vitamin B12 absorption',
            interactions: 'May reduce effectiveness of some HIV drugs, blood thinners',
            category: 'Acid Reflux',
            alternatives: ['ranitidine', 'pantoprazole'],
            prescriptionRequired: false
          },
          'domperidone': {
            uses: 'Nausea, vomiting, bloating, feeling of fullness, gastric motility disorders',
            dosage: 'Adults: 10mg three times daily before meals. Maximum: 80mg daily',
            sideEffects: 'Dry mouth, headache, diarrhea, abdominal cramps',
            warnings: 'Not recommended for cardiac patients. Use lowest effective dose',
            interactions: 'Avoid with certain antifungal and antibiotic medications',
            category: 'Digestive Health',
            alternatives: ['ondansetron'],
            prescriptionRequired: true
          },

          // Diabetes & Blood Sugar
          'metformin': {
            uses: 'Type 2 diabetes blood sugar control, insulin resistance, PCOS',
            dosage: 'Starting: 500mg twice daily with meals. Maximum: 2-2.5g daily. Increase gradually',
            sideEffects: 'Nausea, diarrhea, stomach upset, metallic taste, vitamin B12 deficiency',
            warnings: 'Prescription only. Regular blood sugar monitoring required. Avoid alcohol. Stop before surgery',
            interactions: 'Avoid with certain contrast dyes. May interact with some blood pressure medications',
            category: 'Diabetes Care',
            alternatives: ['gliclazide', 'pioglitazone'],
            prescriptionRequired: true
          },

          // Blood Pressure & Heart
          'amlodipine': {
            uses: 'High blood pressure, angina, coronary artery disease prevention',
            dosage: 'Starting: 5mg once daily. May increase to 10mg daily based on response',
            sideEffects: 'Ankle swelling, flushing, dizziness, fatigue, palpitations',
            warnings: 'Prescription only. Regular blood pressure monitoring. Rise slowly from sitting/lying',
            interactions: 'May interact with grapefruit juice, certain antibiotics',
            category: 'Blood Pressure',
            alternatives: ['lisinopril', 'atenolol'],
            prescriptionRequired: true
          },

          // Antibiotics
          'amoxicillin': {
            uses: 'Bacterial infections: chest, ear, nose, throat, skin, urinary tract infections',
            dosage: 'Adults: 250-500mg three times daily. Children: dose based on weight. Complete full course',
            sideEffects: 'Nausea, diarrhea, skin rash, allergic reactions, thrush',
            warnings: 'Prescription only. Complete full course even if feeling better. Check for penicillin allergy',
            interactions: 'May reduce effectiveness of birth control pills. Avoid with certain medications',
            category: 'Antibiotics',
            alternatives: ['azithromycin', 'cephalexin'],
            prescriptionRequired: true
          },

          // Vitamins & Supplements
          'vitamin d3': {
            uses: 'Bone health, immunity support, calcium absorption, muscle function, mood support',
            dosage: 'Adults: 1000-4000 IU daily. Deficiency treatment: higher doses as prescribed',
            sideEffects: 'Rare: nausea, kidney stones with very high doses',
            warnings: 'Regular monitoring for high doses. Take with fatty meal for better absorption',
            interactions: 'May increase calcium absorption. Monitor with heart medications',
            category: 'Vitamins',
            alternatives: ['vitamin d2', 'calcium with vitamin d'],
            prescriptionRequired: false
          },
          'multivitamin': {
            uses: 'Nutritional supplement, vitamin deficiency prevention, general health support',
            dosage: 'One tablet daily with breakfast or as directed',
            sideEffects: 'Mild stomach upset, constipation, dark stools (from iron)',
            warnings: 'Do not exceed recommended dose. May contain iron - keep away from children',
            interactions: 'May affect absorption of certain medications. Take 2 hours apart from antibiotics',
            category: 'Vitamins',
            alternatives: ['individual vitamins', 'prenatal vitamins'],
            prescriptionRequired: false
          },

          // Women's Health
          'folic acid': {
            uses: 'Pregnancy support, anemia prevention, neural tube defect prevention, cell division',
            dosage: 'Adults: 400-800 mcg daily. Pregnancy: 400-600 mcg daily. Anemia: higher doses',
            sideEffects: 'Rare: stomach upset, sleep problems, confusion',
            warnings: 'Essential during pregnancy. May mask vitamin B12 deficiency',
            interactions: 'May interact with certain seizure medications',
            category: 'Women\'s Health',
            alternatives: ['folate', 'prenatal vitamins'],
            prescriptionRequired: false
          },

          // Skin Care
          'calamine lotion': {
            uses: 'Itchy skin, chickenpox, insect bites, poison ivy, minor skin irritations',
            dosage: 'Apply to affected area 2-3 times daily. Shake well before use',
            sideEffects: 'Rare: skin irritation, allergic reactions',
            warnings: 'For external use only. Avoid eyes and mouth. Discontinue if irritation occurs',
            interactions: 'None significant',
            category: 'Skin Care',
            alternatives: ['hydrocortisone cream', 'aloe vera gel'],
            prescriptionRequired: false
          },

          // Respiratory
          'salbutamol': {
            uses: 'Asthma, bronchospasm, COPD, exercise-induced asthma',
            dosage: 'Inhaler: 1-2 puffs as needed. Maximum: 8 puffs in 24 hours',
            sideEffects: 'Tremor, headache, increased heart rate, muscle cramps',
            warnings: 'Prescription only. Seek medical help if not effective. Monitor heart rate',
            interactions: 'May interact with certain heart medications, diuretics',
            category: 'Respiratory',
            alternatives: ['terbutaline', 'formoterol'],
            prescriptionRequired: true
          }
        };
      }

      async processQuery(transcript, confidence = 0.5) {
        try {
          // Store query in conversation history
          this.conversationHistory.push({
            type: 'user',
            text: transcript,
            timestamp: new Date(),
            confidence: confidence
          });

          // Clean and normalize the transcript
          const cleanQuery = this.cleanQuery(transcript);
          console.log('Processing query:', cleanQuery);
          
          // Check for low confidence and ask for clarification
          if (confidence < 0.3) {
            this.displayResponse({
              text: "I'm not quite sure I understood that correctly. Could you please repeat your question more clearly?",
              type: 'clarification'
            });
            return;
          }
          
          // Enhanced query analysis
          const analysis = this.analyzeQuery(cleanQuery);
          console.log('Query analysis:', analysis);
          
          // Generate response based on analysis
          const response = await this.generateEnhancedMedicalResponse(analysis, cleanQuery);
          
          // Store response in conversation history
          this.conversationHistory.push({
            type: 'assistant',
            text: response.text,
            timestamp: new Date(),
            analysis: analysis
          });
          
          this.displayResponse(response);
          
        } catch (error) {
          console.error('Error processing query:', error);
          this.displayResponse({
            text: "I'm sorry, I encountered an error processing your question. Please try again or consult a healthcare professional for medical advice.",
            type: 'error'
          });
        }
      }

      cleanQuery(query) {
        // Remove filler words and normalize medical terms
        const fillerWords = ['um', 'uh', 'like', 'you know', 'well', 'so', 'actually', 'basically'];
        let cleanedQuery = query.toLowerCase().trim();
        
        // Remove filler words
        fillerWords.forEach(filler => {
          const regex = new RegExp(`\\b${filler}\\b`, 'gi');
          cleanedQuery = cleanedQuery.replace(regex, '');
        });
        
        // Clean up extra spaces
        cleanedQuery = cleanedQuery.replace(/\s+/g, ' ').trim();
        
        // Medical term corrections and synonyms
        const corrections = {
          'panadol': 'paracetamol',
          'tylenol': 'paracetamol',
          'acetaminophen': 'paracetamol',
          'advil': 'ibuprofen',
          'motrin': 'ibuprofen',
          'bayer': 'aspirin',
          'disprin': 'aspirin',
          'zyrtec': 'cetirizine',
          'claritin': 'loratadine',
          'prilosec': 'omeprazole',
          'nexium': 'omeprazole',
          'glucophage': 'metformin',
          'norvasc': 'amlodipine',
          'augmentin': 'amoxicillin',
          'amoxil': 'amoxicillin'
        };
        
        // Apply corrections
        Object.entries(corrections).forEach(([original, corrected]) => {
          const regex = new RegExp(`\\b${original}\\b`, 'gi');
          cleanedQuery = cleanedQuery.replace(regex, corrected);
        });
        
        return cleanedQuery;
      }

      analyzeQuery(query) {
        const analysis = {
          intent: 'general',
          medicines: [],
          queryType: 'general',
          keywords: [],
          symptoms: [],
          urgency: 'normal',
          confidence: 1.0
        };

        // Extract medicine names (check for all medicines in knowledge base)
        Object.keys(this.medicalKnowledgeBase).forEach(medicine => {
          if (query.includes(medicine)) {
            analysis.medicines.push(medicine);
          }
        });

        // Determine query type with more specific patterns
        const queryPatterns = {
          sideEffects: /side effect|adverse|reaction|harmful|danger|risk|problem/i,
          dosage: /dosage|dose|how much|how many|how often|frequency|when to take/i,
          uses: /use|used for|treat|help|cure|good for|indication|purpose/i,
          warnings: /warning|caution|safe|danger|avoid|contraindic|precaution/i,
          interactions: /interact|combine|together|mix|take with|drug interaction/i,
          alternatives: /alternative|substitute|replace|instead|other option|similar/i,
          pregnancy: /pregnant|pregnancy|breastfeed|nursing|expecting/i,
          children: /child|children|kid|baby|infant|pediatric/i,
          emergency: /emergency|urgent|serious|severe|hospital|ambulance|911/i
        };

        Object.entries(queryPatterns).forEach(([type, pattern]) => {
          if (pattern.test(query)) {
            analysis.queryType = type;
          }
        });

        // Extract symptoms for medicine recommendations
        const symptomPatterns = {
          pain: /pain|ache|hurt|sore|painful/i,
          headache: /headache|head pain|migraine/i,
          fever: /fever|temperature|hot|feverish/i,
          cold: /cold|cough|sniff|runny nose|congestion/i,
          allergy: /allergy|allergic|itch|rash|hives|sneez/i,
          stomach: /stomach|tummy|belly|nausea|vomit|indigestion/i,
          heartburn: /heartburn|acid|reflux|gerd/i,
          diabetes: /diabetes|diabetic|blood sugar|glucose/i,
          blood_pressure: /blood pressure|hypertension|bp/i,
          infection: /infection|bacterial|antibiotic/i
        };

        Object.entries(symptomPatterns).forEach(([symptom, pattern]) => {
          if (pattern.test(query)) {
            analysis.symptoms.push(symptom);
          }
        });

        // Check for emergency keywords
        const emergencyPatterns = /chest pain|difficulty breathing|severe|overdose|poisoning|allergic reaction|anaphylax/i;
        if (emergencyPatterns.test(query)) {
          analysis.urgency = 'emergency';
        }

        // Extract general keywords
        const keywordPatterns = ['pain', 'headache', 'fever', 'allergy', 'heartburn', 'diabetes', 'blood pressure', 'infection'];
        analysis.keywords = keywordPatterns.filter(keyword => query.includes(keyword));

        return analysis;
      }

      async generateEnhancedMedicalResponse(analysis, originalQuery) {
        let responseText = '';
        let responseType = 'info';
        let confidence = 0.8;

        // Handle emergency situations first
        if (analysis.urgency === 'emergency') {
          return {
            text: "ðŸš¨ MEDICAL EMERGENCY: If you're experiencing a medical emergency like chest pain, difficulty breathing, or severe allergic reaction, please call emergency services (911/108) immediately or go to the nearest hospital. Do not rely on this app for emergency medical care.",
            type: 'emergency',
            confidence: 1.0
          };
        }

        // Handle specific medicine queries
        if (analysis.medicines.length > 0) {
          const medicine = analysis.medicines[0]; // Focus on first medicine mentioned
          const medicineData = this.medicalKnowledgeBase[medicine];
          const medicineName = medicine.charAt(0).toUpperCase() + medicine.slice(1);

          switch (analysis.queryType) {
            case 'uses':
              responseText = `ðŸ’Š **${medicineName}** is commonly used for: ${medicineData.uses}.\n\nðŸ“‹ **Category:** ${medicineData.category}\n\n`;
              if (medicineData.prescriptionRequired) {
                responseText += "âš ï¸ **Important:** This medicine requires a prescription from a doctor.";
              }
              break;

            case 'dosage':
              responseText = `ðŸ’Š **${medicineName} Dosage Information:**\n\nðŸ“ **Typical Dosage:** ${medicineData.dosage}\n\n`;
              responseText += "âš ï¸ **Important:** Always follow your doctor's instructions or the package directions. Do not exceed the recommended dose.";
              break;

            case 'sideEffects':
              responseText = `âš ï¸ **${medicineName} - Possible Side Effects:**\n\n${medicineData.sideEffects}\n\n`;
              responseText += "ðŸš¨ **When to seek help:** Contact your healthcare provider immediately if you experience any severe side effects or allergic reactions.";
              responseType = 'warning';
              break;

            case 'warnings':
              responseText = `âš ï¸ **${medicineName} - Important Warnings & Precautions:**\n\n${medicineData.warnings}\n\n`;
              if (medicineData.interactions) {
                responseText += `ðŸ”„ **Drug Interactions:** ${medicineData.interactions}`;
              }
              responseType = 'warning';
              break;

            case 'interactions':
              responseText = `ðŸ”„ **${medicineName} - Drug Interactions:**\n\n`;
              if (medicineData.interactions) {
                responseText += `${medicineData.interactions}\n\n`;
              } else {
                responseText += "No significant drug interactions reported, but always inform your doctor about all medications you're taking.\n\n";
              }
              responseText += "ðŸ’¡ **Tip:** Always carry a list of your current medications when visiting healthcare providers.";
              break;

            case 'alternatives':
              responseText = `ðŸ”„ **Alternatives to ${medicineName}:**\n\n`;
              if (medicineData.alternatives && medicineData.alternatives.length > 0) {
                responseText += `**Similar medicines:** ${medicineData.alternatives.map(alt => alt.charAt(0).toUpperCase() + alt.slice(1)).join(', ')}\n\n`;
              }
              responseText += "âš ï¸ **Important:** Never switch medications without consulting your doctor first. What works for others may not be suitable for you.";
              break;

            case 'pregnancy':
              responseText = `ðŸ¤° **${medicineName} and Pregnancy/Breastfeeding:**\n\n`;
              responseText += "This is a specialized medical question that requires consultation with your doctor or pharmacist. Medicine safety during pregnancy and breastfeeding varies greatly between individuals and circumstances.\n\n";
              responseText += "ðŸ“ž **Recommendation:** Please consult your obstetrician, gynecologist, or pharmacist for personalized advice.";
              responseType = 'warning';
              break;

            case 'children':
              responseText = `ðŸ‘¶ **${medicineName} for Children:**\n\n`;
              if (medicineData.dosage.includes('Children')) {
                responseText += `**Pediatric dosing:** ${medicineData.dosage}\n\n`;
              }
              responseText += "âš ï¸ **Important:** Always consult a pediatrician before giving any medication to children. Dosing for children is based on weight and age.";
              responseType = 'warning';
              break;

            default:
              // Comprehensive information
              responseText = `ðŸ’Š **${medicineName} - Complete Information:**\n\n`;
              responseText += `**ðŸŽ¯ Uses:** ${medicineData.uses}\n\n`;
              responseText += `**ðŸ“ Dosage:** ${medicineData.dosage}\n\n`;
              responseText += `**âš ï¸ Important Warnings:** ${medicineData.warnings}`;
              
              if (medicineData.prescriptionRequired) {
                responseText += "\n\nðŸ¥ **Prescription Required:** This medicine requires a doctor's prescription.";
              }
          }
        } 
        // Handle symptom-based queries
        else if (analysis.symptoms.length > 0) {
          responseText = this.recommendMedicineForSymptoms(analysis.symptoms);
          confidence = 0.7;
        }
        // Handle general medical questions
        else {
          responseText = this.handleGeneralMedicalQuery(originalQuery);
          confidence = 0.6;
        }

        // Add medical disclaimer
        responseText += "\n\nðŸ“‹ **Medical Disclaimer:** This information is for educational purposes only and is not a substitute for professional medical advice. Always consult with a healthcare provider for medical concerns, diagnosis, or treatment.";

        return {
          text: responseText,
          type: responseType,
          confidence: confidence
        };
      }

      recommendMedicineForSymptoms(symptoms) {
        const recommendations = {
          pain: {
            medicines: ['paracetamol', 'ibuprofen'],
            advice: 'For general pain relief, paracetamol or ibuprofen are commonly used options. Paracetamol is gentler on the stomach.'
          },
          headache: {
            medicines: ['paracetamol', 'ibuprofen'],
            advice: 'For headaches, paracetamol or ibuprofen can be effective. Stay hydrated and rest in a quiet, dark room.'
          },
          fever: {
            medicines: ['paracetamol', 'ibuprofen'],
            advice: 'For fever reduction, paracetamol or ibuprofen are effective. Stay hydrated and rest.'
          },
          allergy: {
            medicines: ['cetirizine', 'loratadine'],
            advice: 'For allergy symptoms, antihistamines like cetirizine or loratadine can help. Loratadine is less likely to cause drowsiness.'
          },
          heartburn: {
            medicines: ['omeprazole'],
            advice: 'For heartburn and acid reflux, omeprazole can help reduce stomach acid. Avoid spicy and fatty foods.'
          },
          stomach: {
            medicines: ['omeprazole', 'domperidone'],
            advice: 'For stomach issues, the treatment depends on the specific problem. Acid-related issues may benefit from omeprazole.'
          },
          diabetes: {
            medicines: ['metformin'],
            advice: 'Diabetes requires prescription medications like metformin, but this MUST be prescribed by a doctor. Never self-medicate for diabetes.'
          },
          blood_pressure: {
            medicines: ['amlodipine'],
            advice: 'High blood pressure requires prescription medications and MUST be managed by a doctor. Regular monitoring is essential.'
          },
          infection: {
            medicines: ['amoxicillin'],
            advice: 'Bacterial infections require prescription antibiotics like amoxicillin. See a doctor for proper diagnosis and prescription.'
          }
        };

        let response = 'ðŸ” **Based on your symptoms, here are some options:**\n\n';
        
        symptoms.forEach((symptom, index) => {
          if (recommendations[symptom]) {
            const rec = recommendations[symptom];
            response += `**${index + 1}. For ${symptom}:** ${rec.advice}\n`;
            if (rec.medicines.length > 0) {
              response += `   **Suggested medicines:** ${rec.medicines.map(m => m.charAt(0).toUpperCase() + m.slice(1)).join(', ')}\n\n`;
            }
          }
        });

        response += 'âš ï¸ **Important:** These are general suggestions only. For persistent or severe symptoms, please consult a healthcare professional.';
        
        return response;
      }

      handleGeneralMedicalQuery(query) {
        // Handle common general questions
        const generalPatterns = {
          greeting: /hello|hi|hey|good morning|good afternoon|good evening/i,
          help: /help|what can you do|how to use|guide/i,
          app_features: /app|features|medicines|buy|order|prescription/i,
          store_hours: /hours|open|close|time|when/i,
          delivery: /deliver|shipping|how long|fast/i,
          contact: /contact|phone|call|support/i
        };

        for (const [type, pattern] of Object.entries(generalPatterns)) {
          if (pattern.test(query)) {
            switch (type) {
              case 'greeting':
                return "ðŸ‘‹ Hello! I'm MediQuick's AI assistant. I can help you with information about medicines, their uses, dosages, side effects, and general health questions. What would you like to know?";
              
              case 'help':
                return "ðŸ¤– **I can help you with:**\n\nâ€¢ Medicine information (uses, dosages, side effects)\nâ€¢ Health symptoms and treatment suggestions\nâ€¢ Drug interactions and warnings\nâ€¢ General health questions\n\n**Try asking:**\nâ€¢ 'What is paracetamol used for?'\nâ€¢ 'Side effects of ibuprofen'\nâ€¢ 'What medicine for headache?'\nâ€¢ 'Can I take aspirin with food?'";
              
              case 'app_features':
                return "ðŸ“± **MediQuick App Features:**\n\nâ€¢ Browse 30+ medicines with detailed information\nâ€¢ Voice assistant for medical queries\nâ€¢ Prescription verification\nâ€¢ Real-time inventory management\nâ€¢ Multiple pharmacy locations\nâ€¢ Fast delivery (10-45 minutes)\nâ€¢ Secure payment options\n\nYou can browse medicines, add to cart, and get expert medical information!";
              
              case 'store_hours':
                return "ðŸ•’ **Store Hours:**\n\nâ€¢ **Online:** 24/7 available\nâ€¢ **Delivery:** 6 AM - 11 PM daily\nâ€¢ **Emergency Service:** Available for urgent needs\nâ€¢ **Pharmacy Support:** 8 AM - 10 PM\n\nFor emergency medications outside these hours, call our 24/7 helpline!";
              
              case 'delivery':
                return "ðŸšš **Delivery Information:**\n\nâ€¢ **Express Delivery:** 10-15 minutes (â‚¹40 extra)\nâ€¢ **Standard Delivery:** 30-45 minutes (â‚¹40)\nâ€¢ **Free Delivery:** Orders above â‚¹500\nâ€¢ **Coverage:** Dammaiguda & Nagaram areas\n\nWe work with 8+ local pharmacies to ensure fast delivery!";
              
              case 'contact':
                return "ðŸ“ž **Contact & Support:**\n\nâ€¢ **Emergency:** Call 108 or 911\nâ€¢ **Pharmacy Support:** Available in app\nâ€¢ **Technical Help:** Use app feedback option\nâ€¢ **Medical Consultation:** Consult your doctor\n\nFor medicine information, keep asking me questions!";
            }
          }
        }

        // Default response for unrecognized queries
        return "ðŸ¤” I'm not sure I understand that specific question. I can help you with:\n\nâ€¢ Medicine information (paracetamol, ibuprofen, aspirin, etc.)\nâ€¢ Symptoms and treatments\nâ€¢ Drug interactions and side effects\nâ€¢ General health questions\n\n**Try asking something like:**\nâ€¢ 'What is [medicine name] used for?'\nâ€¢ 'Side effects of [medicine]'\nâ€¢ 'What medicine for [symptom]?'\nâ€¢ 'Can I take [medicine] with food?'";
      }

      updateListeningUI(isListening) {
        const micIcon = document.getElementById('micIcon');
        const status = document.getElementById('listeningStatus');
        const visualizer = document.getElementById('audioVisualizer');
        const btn = document.getElementById('startListeningBtn');

        if (isListening) {
          micIcon.textContent = 'mic_off';
          status.textContent = 'Listening... Speak now or click to stop';
          status.style.color = '#10b981';
          visualizer.classList.remove('hidden');
          btn.classList.add('animate-pulse');
          btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        } else {
          micIcon.textContent = 'mic';
          status.textContent = 'Click to start speaking';
          status.style.color = '#6b7280';
          visualizer.classList.add('hidden');
          btn.classList.remove('animate-pulse');
          btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        }
      }

      updateTranscription(text) {
        const transcriptionDisplay = document.getElementById('transcriptionDisplay');
        transcriptionDisplay.textContent = text;
        transcriptionDisplay.style.color = '#374151';
        transcriptionDisplay.style.fontStyle = 'normal';
      }

      displayResponse(response) {
        const responseContent = document.getElementById('responseContent');
        const responseActions = document.getElementById('responseActions');
        
        // Format response text with proper HTML
        let formattedText = response.text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
          .replace(/\n/g, '<br>') // Line breaks
          .replace(/ðŸ’Š|ðŸŽ¯|ðŸ“|âš ï¸|ðŸš¨|ðŸ”„|ðŸ’¡|ðŸ¤°|ðŸ‘¶|ðŸ“‹|ðŸ”|ðŸ‘‹|ðŸ¤–|ðŸ“±|ðŸ•’|ðŸšš|ðŸ“ž|ðŸ¤”/g, '<span style="font-size: 1.2em;">$&</span>'); // Larger emojis

        responseContent.innerHTML = formattedText;
        responseContent.classList.remove('italic', 'text-gray-600');
        responseContent.classList.add('text-gray-800', 'leading-relaxed');
        
        this.currentResponse = response.text;
        responseActions.classList.remove('hidden');

        // Style based on response type
        const responseDisplay = document.getElementById('aiResponseDisplay');
        responseDisplay.className = 'rounded-lg p-4 min-h-[100px] border';
        
        switch (response.type) {
          case 'emergency':
            responseDisplay.classList.add('bg-gradient-to-r', 'from-red-50', 'to-orange-50', 'border-red-200');
            break;
          case 'warning':
            responseDisplay.classList.add('bg-gradient-to-r', 'from-yellow-50', 'to-orange-50', 'border-yellow-200');
            break;
          case 'error':
            responseDisplay.classList.add('bg-gradient-to-r', 'from-red-50', 'to-pink-50', 'border-red-200');
            break;
          default:
            responseDisplay.classList.add('bg-gradient-to-r', 'from-teal-50', 'to-green-50', 'border-teal-200');
        }

        // Auto-scroll to response
        responseDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      handleSpeechError(error) {
        let errorMessage = 'Speech recognition error: ';
        let suggestion = '';
        
        switch (error) {
          case 'no-speech':
            errorMessage += 'No speech was detected.';
            suggestion = 'Please make sure your microphone is working and speak clearly.';
            break;
          case 'audio-capture':
            errorMessage += 'Microphone access denied or not available.';
            suggestion = 'Please check your microphone permissions in browser settings.';
            break;
          case 'not-allowed':
            errorMessage += 'Microphone permission denied.';
            suggestion = 'Please allow microphone access and try again.';
            break;
          case 'network':
            errorMessage += 'Network error occurred.';
            suggestion = 'Please check your internet connection and try again.';
            break;
          default:
            errorMessage += 'An unknown error occurred.';
            suggestion = 'Please try again or type your question instead.';
        }
        
        document.getElementById('transcriptionDisplay').innerHTML = `
          <div class="text-red-600">
            <p class="font-medium">${errorMessage}</p>
            <p class="text-sm mt-1">${suggestion}</p>
          </div>
        `;
        this.updateListeningUI(false);
      }

      showUnsupportedMessage() {
        document.getElementById('transcriptionDisplay').innerHTML = `
          <div class="text-yellow-600">
            <p class="font-medium">Speech recognition not supported in this browser.</p>
            <p class="text-sm mt-1">Please use Chrome, Edge, or Safari for voice features, or type your questions using the quick question buttons below.</p>
          </div>
        `;
      }

      speak(text) {
        if (this.synthesis.speaking) {
          this.synthesis.cancel();
        }

        // Clean text for speech (remove HTML and markdown)
        const cleanText = text
          .replace(/<[^>]*>/g, '') // Remove HTML tags
          .replace(/\*\*(.*?)\*\*/g, '$1') // Remove markdown bold
          .replace(/ðŸ’Š|ðŸŽ¯|ðŸ“|âš ï¸|ðŸš¨|ðŸ”„|ðŸ’¡|ðŸ¤°|ðŸ‘¶|ðŸ“‹|ðŸ”|ðŸ‘‹|ðŸ¤–|ðŸ“±|ðŸ•’|ðŸšš|ðŸ“ž|ðŸ¤”/g, '') // Remove emojis
          .replace(/\s+/g, ' ') // Clean up extra spaces
          .trim();

        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = 0.85;
        utterance.pitch = 1.0;
        utterance.volume = 0.8;
        
        if (this.preferredVoice) {
          utterance.voice = this.preferredVoice;
        }

        utterance.onstart = () => {
          console.log('Speech synthesis started');
        };

        utterance.onend = () => {
          console.log('Speech synthesis completed');
        };

        utterance.onerror = (event) => {
          console.error('Speech synthesis error:', event.error);
        };

        this.synthesis.speak(utterance);
      }
    }

    // Initialize voice assistant
    const voiceAssistant = new MedicalVoiceAssistant();

    // Voice Assistant Functions
    function toggleVoiceAssistant() {
      const modal = document.getElementById('voiceAssistantModal');
      modal.classList.toggle('hidden');
      
      // Reset the voice assistant state when opening
      if (!modal.classList.contains('hidden')) {
        // Clear previous transcription and response
        document.getElementById('transcriptionDisplay').innerHTML = 
          '<span class="text-gray-600 italic">Your speech will appear here...</span>';
        document.getElementById('responseContent').innerHTML = 
          '<span class="text-gray-600 italic">Ask me anything about medicines...</span>';
        document.getElementById('responseActions').classList.add('hidden');
        
        // Reset listening UI
        voiceAssistant.updateListeningUI(false);
        
        console.log('Voice assistant modal opened');
      }
    }

    function closeVoiceAssistant() {
      const modal = document.getElementById('voiceAssistantModal');
      modal.classList.add('hidden');
      
      // Stop listening if active
      if (voiceAssistant.isListening && voiceAssistant.recognition) {
        voiceAssistant.recognition.stop();
      }
      
      // Stop any ongoing speech synthesis
      if (voiceAssistant.synthesis.speaking) {
        voiceAssistant.synthesis.cancel();
      }
      
      console.log('Voice assistant modal closed');
    }

    function startListening() {
      if (!voiceAssistant.recognition) {
        voiceAssistant.showToast('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.', 'error');
        return;
      }

      if (voiceAssistant.isListening) {
        console.log('Stopping voice recognition');
        voiceAssistant.recognition.stop();
      } else {
        console.log('Starting voice recognition');
        
        // Clear previous transcription
        document.getElementById('transcriptionDisplay').innerHTML = 
          '<span class="text-blue-600 italic">Listening... Please speak now</span>';
        
        try {
          voiceAssistant.recognition.start();
        } catch (error) {
          console.error('Error starting speech recognition:', error);
          voiceAssistant.handleSpeechError('not-allowed');
        }
      }
    }

    function askQuickQuestion(question) {
      console.log('Quick question asked:', question);
      
      // Display the question in transcription
      document.getElementById('transcriptionDisplay').innerHTML = 
        `<span class="text-gray-800">${question}</span>`;
      
      // Process the question
      voiceAssistant.processQuery(question, 1.0);
    }

    function speakResponse() {
      if (!voiceAssistant.currentResponse) {
        voiceAssistant.showToast('No response to speak', 'info');
        return;
      }
      
      console.log('Speaking response');
      voiceAssistant.speak(voiceAssistant.currentResponse);
    }

    function copyResponse() {
      if (!voiceAssistant.currentResponse) {
        voiceAssistant.showToast('No response to copy', 'info');
        return;
      }
      
      // Clean the response text before copying
      const cleanText = voiceAssistant.currentResponse
        .replace(/\*\*(.*?)\*\*/g, '$1') // Remove markdown bold
        .replace(/ðŸ’Š|ðŸŽ¯|ðŸ“|âš ï¸|ðŸš¨|ðŸ”„|ðŸ’¡|ðŸ¤°|ðŸ‘¶|ðŸ“‹|ðŸ”|ðŸ‘‹|ðŸ¤–|ðŸ“±|ðŸ•’|ðŸšš|ðŸ“ž|ðŸ¤”/g, '') // Remove emojis
        .replace(/\s+/g, ' ') // Clean up extra spaces
        .trim();
      
      navigator.clipboard.writeText(cleanText).then(() => {
        voiceAssistant.showToast('Response copied to clipboard!', 'success');
        console.log('Response copied to clipboard');
      }).catch(() => {
        // Fallback for browsers that don't support clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = cleanText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          voiceAssistant.showToast('Response copied to clipboard!', 'success');
        } catch (err) {
          voiceAssistant.showToast('Failed to copy response', 'error');
        }
        document.body.removeChild(textArea);
      });
    }

    // Add toast functionality to voice assistant
    voiceAssistant.showToast = function(message, type = 'success') {
      const toast = document.createElement('div');
      let bgColor, icon;
      
      switch(type) {
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'error';
          break;
        case 'info':
          bgColor = 'bg-blue-500';
          icon = 'info';
          break;
        case 'warning':
          bgColor = 'bg-yellow-500';
          icon = 'warning';
          break;
        default:
          bgColor = 'bg-green-500';
          icon = 'check_circle';
      }
      
      toast.className = `fixed bottom-6 right-6 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transition-all transform translate-y-0 opacity-100 z-50`;
      toast.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="material-icons text-sm">${icon}</i>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(toast);

      // Auto remove after delay
      const delay = type === 'error' ? 5000 : type === 'info' ? 3000 : 3000;
      setTimeout(() => {
        toast.style.transform = 'translateY(20px)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, delay);
    };

    // Enhanced quick questions for better testing
    const enhancedQuickQuestions = [
      "What is paracetamol used for?",
      "Side effects of ibuprofen", 
      "Can I take aspirin with food?",
      "What helps with allergies?",
      "Dosage of omeprazole",
      "What medicine for headache?",
      "Drug interactions of metformin",
      "Is cetirizine safe for children?",
      "Alternative to paracetamol",
      "What are the app features?"
    ];

    // Update quick questions in the modal
    document.addEventListener('DOMContentLoaded', function() {
      const quickQuestionsContainer = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-2');
      if (quickQuestionsContainer) {
        quickQuestionsContainer.innerHTML = enhancedQuickQuestions.slice(0, 4).map(question => `
          <button onclick="askQuickQuestion('${question}')" 
                  class="text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all text-sm">
            "${question}"
          </button>
        `).join('');
      }
    });

    // Initialize voice assistant with better error handling
    console.log('Initializing Enhanced Voice Assistant...');
    
    // Check for browser support
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      console.warn('Speech recognition not supported in this browser');
    } else {
      console.log('Speech recognition supported');
    }

    if (!('speechSynthesis' in window)) {
      console.warn('Speech synthesis not supported in this browser');
    } else {
      console.log('Speech synthesis supported');
    }

    // Add keyboard shortcuts for voice assistant
    document.addEventListener('keydown', function(event) {
      // Press 'V' to toggle voice assistant
      if (event.key === 'v' || event.key === 'V') {
        if (!document.getElementById('voiceAssistantModal').classList.contains('hidden')) {
          return; // Don't toggle if modal is open and user is typing
        }
        toggleVoiceAssistant();
      }
      
      // Press Space to start/stop listening when modal is open
      if (event.code === 'Space') {
        const modal = document.getElementById('voiceAssistantModal');
        if (!modal.classList.contains('hidden')) {
          event.preventDefault();
          startListening();
        }
      }
      
      // Press Escape to close voice assistant
      if (event.key === 'Escape') {
        const modal = document.getElementById('voiceAssistantModal');
        if (!modal.classList.contains('hidden')) {
          closeVoiceAssistant();
        }
      }
    });

    // Add help tooltip for voice assistant button
    document.addEventListener('DOMContentLoaded', function() {
      const voiceBtn = document.getElementById('voiceAssistantBtn');
      if (voiceBtn) {
        voiceBtn.title = 'AI Voice Assistant (Press V to toggle)';
      }
    });

    // Update cart badge
    updateCartBadge();
    
    // Initialize wishlist and compare badges
    const updateWishlistBadge = () => {
      const badge = document.getElementById('wishlistBadge');
      if (badge) {
        const wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
        badge.textContent = wishlistItems.length;
        badge.classList.toggle('hidden', wishlistItems.length === 0);
      }
    };

    const updateCompareBadge = () => {
      const badge = document.getElementById('compareBadge');
      if (badge) {
        const compareItems = JSON.parse(localStorage.getItem('compareItems') || '[]');
        badge.textContent = compareItems.length;
        badge.classList.toggle('hidden', compareItems.length === 0);
      }
    };

    // Modern Pharmacy App Functions
    function addToWishlist(medicineId) {
      const wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
      const medicine = medicineDisplay.mockData.find(item => item.medicine._id === medicineId);
      if (!medicine) return;

      const existingIndex = wishlistItems.findIndex(item => item.id === medicineId);
      if (existingIndex === -1) {
        wishlistItems.push({
          id: medicineId,
          name: medicine.medicine.name,
          price: medicine.medicine.price,
          category: medicine.medicine.category,
          addedAt: new Date().toISOString()
        });
        localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
        updateWishlistBadge();
        showToast(`${medicine.medicine.name} added to wishlist!`, 'success');
      } else {
        showToast(`${medicine.medicine.name} is already in your wishlist`, 'info');
      }
    }

    function addToCompare(medicineId) {
      const compareItems = JSON.parse(localStorage.getItem('compareItems') || '[]');
      if (compareItems.length >= 4) {
        showToast('You can only compare up to 4 medicines', 'error');
        return;
      }

      const medicine = medicineDisplay.mockData.find(item => item.medicine._id === medicineId);
      if (!medicine) return;

      const existingIndex = compareItems.findIndex(item => item.id === medicineId);
      if (existingIndex === -1) {
        compareItems.push({
          id: medicineId,
          name: medicine.medicine.name,
          price: medicine.medicine.price,
          category: medicine.medicine.category,
          manufacturer: medicine.medicine.manufacturer,
          addedAt: new Date().toISOString()
        });
        localStorage.setItem('compareItems', JSON.stringify(compareItems));
        updateCompareBadge();
        showToast(`${medicine.medicine.name} added to compare!`, 'success');
      } else {
        showToast(`${medicine.medicine.name} is already in compare list`, 'info');
      }
    }

    function shareMedicine(medicineId) {
      const medicine = medicineDisplay.mockData.find(item => item.medicine._id === medicineId);
      if (!medicine) return;

      if (navigator.share) {
        navigator.share({
          title: `${medicine.medicine.name} - ${medicine.medicine.brandName}`,
          text: `Check out this medicine: ${medicine.medicine.description}`,
          url: window.location.href
        }).catch(console.error);
      } else {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          showToast('Link copied to clipboard!', 'success');
        }).catch(() => {
          showToast('Unable to share', 'error');
        });
      }
    }

    function notifyWhenAvailable(medicineId) {
      const medicine = medicineDisplay.mockData.find(item => item.medicine._id === medicineId);
      if (!medicine) return;
      showToast(`We'll notify you when ${medicine.medicine.name} is back in stock!`, 'success');
    }

    function toggleWishlist() {
      const wishlistItems = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
      if (wishlistItems.length === 0) {
        showToast('Your wishlist is empty', 'info');
        return;
      }
      showToast('Wishlist feature coming soon!', 'info');
    }

    function toggleCompare() {
      const compareItems = JSON.parse(localStorage.getItem('compareItems') || '[]');
      if (compareItems.length === 0) {
        showToast('No medicines to compare', 'info');
        return;
      }
      showToast('Compare feature coming soon!', 'info');
    }

    function callNearestPharmacy() {
      if (medicineDisplay && medicineDisplay.realMedicalShops && medicineDisplay.realMedicalShops.length > 0) {
        const nearestPharmacy = medicineDisplay.realMedicalShops[0];
        const phoneNumber = nearestPharmacy.phone;
        const confirmed = confirm(`Call ${nearestPharmacy.name}?\n${phoneNumber}`);
        if (confirmed) {
          window.location.href = `tel:${phoneNumber}`;
        }
      } else {
        showToast('Unable to find nearby pharmacy contact', 'error');
      }
    }

    function emergencyServices() {
      // Navigate to emergency page
      window.location.href = 'emergency.html';
    }

    function findNearestHospital() {
      const url = `https://www.google.com/maps/search/hospital+near+me`;
      window.open(url, '_blank');
    }

  </script>
</body>
</html>